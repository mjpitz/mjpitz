<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  class="html"
><head>
    <title>
        
        Mya Pitzeruse
        |
        Running a Service Mesh on Raspberry Pis


        


        
    </title>

    
    <meta charset="utf-8" /><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="author" content="Mya Pitzeruse" />
    <meta
            name="description"
            content="
      Mom | Homesteader | Software Engineer


    "
    />
    
    
    
    
    <link
            rel="stylesheet"
            href="/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css"
            integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o="
            crossorigin="anonymous"
            type="text/css"
    />

    

    
    <link
            rel="stylesheet"
            href="/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css"
            integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU="
            crossorigin="anonymous"
            type="text/css"
    />
    
    
    <link
            rel="stylesheet"
            href="/css/overrides.min.2d385947a11fbf61dff71c6e1c2c2efa0a51dcf47be66f416fb97b3cca833a65.css"
            integrity="sha256-LThZR6Efv2Hf9xxuHCwu&#43;gpR3PR75m9Bb7l7PMqDOmU="
            crossorigin="anonymous"
            media="screen"
    />

    
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css"
            integrity="sha256-scTmoQvbqwHzP/&#43;deIFu5oz5qacx8HZor9VGp5kky4A="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css"
            integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css"
            integrity="sha256-t9VBM7J&#43;W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />

    <link rel="canonical" href="https://mjpitz.com/blog/2020/11/23/service-mesh-rpi/">

    
    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js"
            integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0="
            crossorigin="anonymous"
    ></script>

    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-theme-switcher.min.5557c8ff5617a01067ac258fd70b9b992506e379317b0da51e5e0f6e018b408a.js"
            integrity="sha256-VVfI/1YXoBBnrCWP1wubmSUG43kxew2lHl4PbgGLQIo="
            crossorigin="anonymous"
    ></script>

    

    


    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Running a Service Mesh on Raspberry Pis"/>
<meta name="twitter:description" content="Many people have asked how to support deploying service mesh to Raspberry Pis.
It wasn&rsquo;t until September that this started to be possible.
Linkerd recently released support for arm64, but has had support for it in edge versions since August.
Many envoy based service mesh have been blocked by support for an arm-compatible envoy image.
Consul is a powerful service discovery and configuration management tool from Hashicorp.
It has a long history of supporting a variety of execution platforms, operating systems, and architectures.
In 1.2, Hashicorp introduced Consul Connect, an envoy based service mesh integration.
This allows Consul to control and direct clients in the service mesh data plane.
In this post, I&rsquo;ll demonstrate how to deploy Consul to support a service mesh on Raspberry Pis."/>



    
    <meta property="og:title" content="Running a Service Mesh on Raspberry Pis" />
<meta property="og:description" content="Many people have asked how to support deploying service mesh to Raspberry Pis.
It wasn&rsquo;t until September that this started to be possible.
Linkerd recently released support for arm64, but has had support for it in edge versions since August.
Many envoy based service mesh have been blocked by support for an arm-compatible envoy image.
Consul is a powerful service discovery and configuration management tool from Hashicorp.
It has a long history of supporting a variety of execution platforms, operating systems, and architectures.
In 1.2, Hashicorp introduced Consul Connect, an envoy based service mesh integration.
This allows Consul to control and direct clients in the service mesh data plane.
In this post, I&rsquo;ll demonstrate how to deploy Consul to support a service mesh on Raspberry Pis." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mjpitz.com/blog/2020/11/23/service-mesh-rpi/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-23T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-23T00:00:00&#43;00:00" /><meta property="og:site_name" content="Mya Pitzeruse" />




    
    
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "blog",
        "name": "Running a Service Mesh on Raspberry Pis",
        "headline": "Running a Service Mesh on Raspberry Pis",
        "alternativeHeadline": "",
        "description": "
      
        \u003cp\u003eMany people have asked how to support deploying service mesh to Raspberry Pis.\nIt wasn\u0026rsquo;t until September that this started to be possible.\n\u003ca href=\u0022https:\/\/github.com\/linkerd\/linkerd2\/releases\/tag\/stable-2.9.0\u0022\u003eLinkerd\u003c\/a\u003e recently released support for arm64, but has had support for it in edge versions since August.\nMany \u003ca href=\u0022https:\/\/envoyproxy.io\/\u0022\u003eenvoy\u003c\/a\u003e based service mesh have been blocked by support for an arm-compatible envoy image.\u003c\/p\u003e\n\u003cp\u003e\u003ca href=\u0022https:\/\/www.consul.io\/\u0022\u003eConsul\u003c\/a\u003e is a powerful service discovery and configuration management tool from \u003ca href=\u0022https:\/\/www.hashicorp.com\/\u0022\u003eHashicorp\u003c\/a\u003e.\nIt has a long history of supporting a variety of execution platforms, operating systems, and architectures.\nIn 1.2, Hashicorp introduced \u003ca href=\u0022https:\/\/www.consul.io\/docs\/connect\u0022\u003eConsul Connect\u003c\/a\u003e, an envoy based service mesh integration.\nThis allows Consul to control and direct clients in the service mesh data plane.\u003c\/p\u003e\n\u003cp\u003eIn this post, I\u0026rsquo;ll demonstrate how to deploy Consul to support a service mesh on Raspberry Pis.\u003c\/p\u003e


      


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mjpitz.com\/blog\/2020\/11\/23\/service-mesh-rpi\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "creator" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightYear" : "2020",
        "dateCreated": "2020-11-23T00:00:00.00Z",
        "datePublished": "2020-11-23T00:00:00.00Z",
        "dateModified": "2020-11-23T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Mya Pitzeruse",
            "url": "https://mjpitz.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/mjpitz.com\/img\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/mjpitz.com\/blog\/2020\/11\/23\/service-mesh-rpi\/",
        "wordCount" : "847",
        "genre" : [ ],
        "keywords" : [ 
      
      "software development"

    ]
    }
  </script>



</head>
<body
    
      class="body theme--light"

    
  >
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"

        
      ><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/img/mjpitz.jpeg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Mya Pitzeruse</a>
        </div>

      
      <div class="sidebar__introduction-description">
        <p>Mom | Homesteader | Software Engineer</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/mjpitz"
            target="_blank"
            rel="noopener"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/mjpitz/"
            target="_blank"
            rel="noopener"
            aria-label="LinkedIn"
            title="LinkedIn"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="/index.xml"
            target="_blank"
            rel="noopener"
            aria-label="Feed"
            title="Feed"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer__sidebar">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"

        
      >
        <header class="header"><div
  class="
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
      
        
        
          <li class="nav__list-item">
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/blog/"
              
              title=""
              >Blog</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/charts/"
              
              title=""
              >Charts</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/media/"
              
              title=""
              >Media</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/papers/"
              
              title=""
              >Papers</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/projects/"
              
              title=""
              >Projects</a
            >
          </li>

        


      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>

      
    </ul>
  </nav>
</div>
</header>
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h3>Running a Service Mesh on Raspberry Pis</h3>
        
        <div class="info">
          <i class="fa fa-sun-o"></i><span class="date">Mon, Nov 23, 2020</span>
          <i class="fa fa-clock-o"></i><span class="reading-time">4-minute read</span>
        </div>
        
        </div>

    <p>Many people have asked how to support deploying service mesh to Raspberry Pis.
It wasn&rsquo;t until September that this started to be possible.
<a href="https://github.com/linkerd/linkerd2/releases/tag/stable-2.9.0">Linkerd</a> recently released support for arm64, but has had support for it in edge versions since August.
Many <a href="https://envoyproxy.io/">envoy</a> based service mesh have been blocked by support for an arm-compatible envoy image.</p>
<p><a href="https://www.consul.io/">Consul</a> is a powerful service discovery and configuration management tool from <a href="https://www.hashicorp.com/">Hashicorp</a>.
It has a long history of supporting a variety of execution platforms, operating systems, and architectures.
In 1.2, Hashicorp introduced <a href="https://www.consul.io/docs/connect">Consul Connect</a>, an envoy based service mesh integration.
This allows Consul to control and direct clients in the service mesh data plane.</p>
<p>In this post, I&rsquo;ll demonstrate how to deploy Consul to support a service mesh on Raspberry Pis.</p>
<h2 id="my-setup">My setup</h2>
<p>To offer some transparency here, I&rsquo;m working with a fresh deployment of <a href="https://k3s.io/">k3s</a> <code>v1.19.1-k3s1</code>.
I run a single server agent in docker on top of a Raspberry Pi 4, and 4 worker nodes on Raspberry Pi 3b+.
There&rsquo;s nothing specific to my setup in this post, but I find it helpful to understand what I&rsquo;m working with.</p>
<p>As usual, all configuration for this post is available on <a href="https://gist.github.com/mjpitz/f88bac2edfaebd67f2a2148829e053bb">GitHub</a>.</p>
<h2 id="deploy-consul">Deploy consul</h2>
<p>First, we&rsquo;ll want to deploy Consul.
The easiest way I found to do this was using the <a href="https://helm.sh">Helm</a> chart provided by Hashicorp.
The default configuration won&rsquo;t work out of box, so we need to make a few modifications.
Below, you&rsquo;ll find a snippet from the <code>consul-values.yaml</code> file included in the Gist.
Here, we override the envoy image used by Consul connect to support arm64.
(<code>envoyproxy/envoy-alpine</code> does not yet support <code>arm64</code>.)</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">global</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 1.16 supports both amd64 and arm64 compatible</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imageEnvoy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">envoyproxy/envoy:v1.16.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">connectInject</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></td></tr></table>
</div>
</div><p>Next, we can deploy consul.
Simply pass in our associated values.yaml file when performing the installation (or upgrade).</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm repo add hashicorp https://helm.releases.hashicorp.com
<span style="color:#8f5902;font-style:italic"># or `helm repo update` if you already have it</span>
  
kubectl create ns consul
helm upgrade -i consul hashicorp/consul -n consul -f consul-values.yaml
</code></pre></td></tr></table>
</div>
</div><p>That <em>should</em> be it.
Consul should be up and running, ready to inject your workloads with an envoy sidecar.</p>
<h2 id="deploy-a-workload">Deploy a workload</h2>
<p>With Cosnsul Connect running, we want to tell it to inject our workloads with an envoy container.
We do this by adding the <code>consul.hashicorp.com/connect-inject=true</code> annotation to the pods.
While you can deploy any project you want, I&rsquo;ll be demonstrating this with my project, <a href="https://deps.cloud">deps.cloud</a>.
In order to run this system, we&rsquo;ll need a <a href="https://www.postgresql.org/">PostgreSQL</a> database.
I provided a developer configuration that can be used with my postgresql-dev chart.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm repo add mjpitz https://mjpitz.github.io/charts/
<span style="color:#8f5902;font-style:italic"># or `helm repo update` if you already have it</span>

helm upgrade -i postgresql-dev mjpitz/postgresql-dev -f postgresql-dev-values.yaml
</code></pre></td></tr></table>
</div>
</div><p>Once PostgreSQL is running we can look at deploying our workloads.
In order for systems to connect to each other when using Consul connect, you need to specify the <code>consul.hashicorp.com/connect-service-upstreams</code> annotation.
This annotation lists the upstream services your process intends to connect to.
Below, you can find some examples on how to use the annotations.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#8f5902;font-style:italic"># for a single service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">consul.hashicorp.com/connect-service-upstreams</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgresql-dev:5432&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># for multiple services</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">consul.hashicorp.com/connect-service-upstreams</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;depscloud-extractor:9000,depscloud-tracker:9001&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>Note:</strong> the ports in the annotation do not have to be the same as the remote service port.
This really tripped me up when working with upstreams.
I was really confused when the value I expected to enter (<code>depscloud-extractor:8090,depscloud-tracker:8090</code>) yielded an error.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl logs -n depscloud depscloud-gateway-7579687f59-w9g92 consul-connect-inject-init
Error: service <span style="color:#4e9a06">&#34;gateway-sidecar-proxy&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span> error occurred:
        * upstreams cannot contain duplicates by <span style="color:#204a87">local</span> <span style="color:#204a87">bind</span> address and port<span style="color:#000;font-weight:bold">;</span> <span style="color:#4e9a06">&#34;127.0.0.1:8090&#34;</span> is specified twice
</code></pre></td></tr></table>
</div>
</div><p>In digging a little further, I learned Consul Connect binds these ports locally.
At first, it felt odd these ports even needed to be specified.
Many other service mesh solutions are able to do this without the need for specification.
It does make sense though.
You don&rsquo;t want your service mesh binding to a port already in use.
The easiest way to get around that is just by being explicit.
Now, you shouldn&rsquo;t need to modify how your services address your remotes.
For example, my applications still target port <code>8090</code> despite using different ports on the upstream annotation.</p>
<p>To deploy deps.cloud using the provided configuration, you will need to clone the deploy repository.
I expect the associated changes to be available in <code>v0.2.33</code>, once published.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># helm repo add depscloud https://depscloud.github.io/deploy/charts</span>
<span style="color:#8f5902;font-style:italic"># or `helm repo update` if you already have it</span>

git clone https://github.com/depscloud/deploy.git
helm upgrade -i depscloud ./deploy/charts/depscloud -f depscloud-values.yaml
</code></pre></td></tr></table>
</div>
</div><p>This will bring the deps.cloud ecosystem up on top of the Consul connect mesh.</p>
<h2 id="next-steps">Next steps</h2>
<p>For me, this was just a stepping stone.
Similar to Linkerd and Istio, Consul Connect doesn&rsquo;t quite handle cronjob termination properly.
Using proxy-based service mesh has some advantages, it&rsquo;s not always ideal.
In a resource constrained environment like Raspberry Pi&rsquo;s, the overhead of an additional proxy and sidecar per pod is rough.
In the next couple of weeks, I&rsquo;ll be playing around with <a href="https://github.com/grpc/grpc-go/blob/master/examples/features/xds/">gRPC&rsquo;s XDS integration</a> for a proxy-less service mesh.</p>
<p>Stay tuned to see it all in action!</p>
    </div>
    <div class="post-footer">
      <div class="info">
        
        <span><a class="tag" href="/tags/software-development/">software development</a></span>


      </div>
    </div>

    
</div>


      </main>
    </div><footer class="footer footer__base">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></body>
</html>
