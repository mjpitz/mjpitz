<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo><head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.0.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mjpitz.com/blog/2020/11/03/registry-123/"><!-- Primary Meta Tags --><title>Docker Registry Setup</title><meta name="title" content="Docker Registry Setup"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mjpitz.com/blog/2020/11/03/registry-123/"><meta property="og:title" content="Docker Registry Setup"><meta property="og:description" content=""><meta property="og:image" content="https://mjpitz.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mjpitz.com/blog/2020/11/03/registry-123/"><meta property="twitter:title" content="Docker Registry Setup"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mjpitz.com/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/_...slug_.e98600b1.css" />
<style type="text/css">main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:var(--color-text)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head><body data-astro-cid-bvzihdzo><header data-astro-cid-3ef6ksr2><nav data-astro-cid-3ef6ksr2><div class="theme-switch-wrapper"><label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox"><div class="slider"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div></label></div><h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mya Pitzeruse</a></h2><div class="internal-links" data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Home</a><a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Blog</a><a href="/charts" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Charts</a><a href="/media" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Media</a><a href="/papers" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Papers</a></div><div class="social-links" data-astro-cid-3ef6ksr2><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-3ef6ksr2></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-3ef6ksr2></path></svg></a></div></nav></header><main data-astro-cid-bvzihdzo><article data-astro-cid-bvzihdzo><div class="hero-image" data-astro-cid-bvzihdzo><img width="1020" height="510" src="/img/blog-placeholder-2.jpg" alt="" data-astro-cid-bvzihdzo></div><div class="prose" data-astro-cid-bvzihdzo><div class="title" data-astro-cid-bvzihdzo><div class="date" data-astro-cid-bvzihdzo><time datetime="2020-11-03T00:00:00.000Z">Nov 3, 2020</time></div><h1 data-astro-cid-bvzihdzo>Docker Registry Setup</h1><hr data-astro-cid-bvzihdzo></div><p>DockerHub’s <a href="https://docs.docker.com/docker-hub/download-rate-limit/">impending download rate limit</a> presents an interesting challenge for some.
From hobbyists to open core ecosystems, projects are trying to find ways insulate their users.
For my projects, I chose to deploy a simple registry mirror.
One nice thing about this project is that the system is largely stateless (and cheap to run).
The <code>docker-registry</code> and <code>docker-auth</code> projects are horizontally scalable.
The only stateful system you really need to manage is a cache (which isn’t mission critical).
While <a href="https://goharbor.io/">Harbor</a> was appealing, it had a lot more overhead than what I needed.
In this post, I’ll walk you through my deployment.</p>
<!--more-->
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>An <a href="https://aws.amazon.com/s3">Amazon S3</a> like system (<a href="https://min.io/">minio</a>)</li>
<li>A <a href="https://kubernetes.io/">Kubernetes</a> cluster
<ul>
<li>Required (or equivalent): <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
<li>Optional: <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a></li>
<li>My Stack: <a href="https://cert-manager.io/">cert-manager</a>, <a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a>, and <a href="https://github.com/kubernetes-sigs/external-dns">external-dns</a>.</li>
</ul>
</li>
<li>A domain or subdomain to work on.
<ul>
<li>If running locally, take a look at how to setup a <a href="https://mjpitz.com/blog/2020/10/21/local-ingress-domains-kind/">local domain with kind</a>.</li>
</ul>
</li>
</ul>
<h3 id="overview">Overview</h3>
<p>Unlike many of my posts, I tried to externalize resources this time around instead of inlining them.
All the configuration used in this project can be found <a href="https://gist.github.com/mjpitz/53e1d92cb0f2dc68e06e5c405f67e04f">here</a>.
Below, you’ll find an overview of the ecosystem.</p>
<p><img src="/img/2020-11-02-registry-overview.png" alt="system overview"></p>
<p>First, we’ll deploy a simple <a href="https://redislabs.com/">Redis</a> cluster.
Once up and running, we’ll deploy a read-only <a href="https://docs.docker.com/registry/">registry</a> mirror.
Finally, we’ll add <a href="https://github.com/cesanta/docker_auth">token authentication</a> to lock down repo access.</p>
<h3 id="configuration">Configuration</h3>
<p>Before getting into things, let’s prepare our configuration.
These values will be used throughout the process and should be unique to your deployment.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D"># s3 configuration</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> AWS_ACCESS_KEY_ID</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"???"</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> AWS_SECRET_ACCESS_KEY</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"???"</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> S3_REGION</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> S3_ENDPOINT</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> S3_BUCKET</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># obtained from https://hub.docker.com/settings/security</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> DOCKERHUB_USERNAME</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> DOCKERHUB_ACCESS_TOKEN</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># only allow images from mjpitz to be pulled </span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> DOCKERHUB_ALLOWED</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"mjpitz"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> REDIS_PASSWORD</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">uuidgen</span><span style="color: #9ECBFF">)</span></span></code></pre>
<p>In addition to that configuration, we will need to tap a couple <a href="https://helm.sh/">Helm</a> repositories.
<code>stable</code> provides a well-supported <code>docker-registry</code> chart.
<code>bitnami</code> provides a couple <code>redis</code> charts sufficient for use with the registry.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">repo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">add</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">stable</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">https://kubernetes-charts.storage.googleapis.com</span></span>
<span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">repo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">add</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">bitnami</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">https://charts.bitnami.com/bitnami</span></span>
<span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">repo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">update</span></span></code></pre>
<h3 id="deploy-a-redis-cluster">Deploy a redis cluster</h3>
<p>First things first, docker-registry supports caching blobs read from the S3 backend.
It supports two types of drivers: <code>inmemory</code> and <code>redis</code>.
For our deployment, we’ll be using redis.
<a href="https://bitnami.com/">Bitnami</a> provides a <code>redis</code> and a <code>redis-cluster</code> chart.
The <code>redis</code> chart offers a primary-replica scheme.
A <code>redis-cluster</code> provides multiple primaries, improving the availability of writes.
For our sake, we’re just going to use the <code>redis</code> chart.
All we need to do, is provide a password.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">upgrade</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-i</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">redis</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">bitnami/redis</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--version</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">11.2</span><span style="color: #9ECBFF">.3</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">password=</span><span style="color: #E1E4E8">${REDIS_PASSWORD}</span></span></code></pre>
<h3 id="deploy-the-registry">Deploy the registry</h3>
<p>Once we have Redis and S3 ready, we should be able to deploy the registry.
For this, you will need my <a href="https://gist.github.com/mjpitz/53e1d92cb0f2dc68e06e5c405f67e04f#file-01-docker-registry-values-yaml">01-docker-registry-values.yaml</a> file from the gist.
This file configures the registry to:</p>
<ul>
<li>Store data in an S3 bucket</li>
<li>Cache blobs in redis</li>
<li>Run in a readonly mode (toggled by setting <code>configData.storage.maintenance.readonly.enabled=false</code>)</li>
<li>Proxy requests to DockerHub (toggled by setting <code>configData.proxy=</code>)</li>
</ul>
<p>All we need to do is plug in our values from earlier.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">upgrade</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-i</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">docker-registry</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">stable/docker-registry</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--version</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1.9</span><span style="color: #9ECBFF">.4</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">-f</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">01</span><span style="color: #9ECBFF">-docker-registry-values.yaml</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">secrets.s3.accessKey=</span><span style="color: #E1E4E8">${AWS_ACCESS_KEY_ID} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">secrets.s3.secretKey=</span><span style="color: #E1E4E8">${AWS_SECRET_ACCESS_KEY} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.region=</span><span style="color: #E1E4E8">${S3_REGION} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.regionEndpoint=</span><span style="color: #E1E4E8">${S3_ENDPOINT} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.bucket=</span><span style="color: #E1E4E8">${S3_BUCKET} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.redis.password=</span><span style="color: #E1E4E8">${REDIS_PASSWORD} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.proxy.username=</span><span style="color: #E1E4E8">${DOCKERHUB_USERNAME} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.proxy.password=</span><span style="color: #E1E4E8">${DOCKERHUB_ACCESS_TOKEN}</span></span></code></pre>
<p>Just like that, you should have a registry mirror up and running.
You can test this by port-forwarding to the pod and attempting to pull any image from DockerHub.
While being able to pull data from DockerHub is great, this <em>could</em> be used maliciously.
For example, <em>someone</em> could start pulling every image, for every tag on DockerHub.
This can result in bloating your image registry with images you didn’t intend to host.</p>
<h3 id="adding-authentication">Adding authentication</h3>
<p><a href="https://github.com/cesanta/docker_auth">docker_auth</a> was built to fill in the authentication (authn) and authorization (authz) gap for Docker.
It was one of the first systems to support Docker’s token authentication flow.
The flow uses signed JWT tokens to verify identity claims by clients.
In order for it to work, we need to generate a private key and certificate.
Together, these are used to sign JWT token.
Using the commands below, we can generate the key and certificate.
Be sure to change the <code>-subj</code> line to something appropriate for your project.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">openssl</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">req</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-new</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-newkey</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">rsa:4096</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-days</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">5000</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-nodes</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-x509</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #79B8FF">-subj</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"/C=DE/ST=BW/L=Mannheim/O=ACME/CN=docker-auth"</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #79B8FF">-keyout</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">tls.key</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #79B8FF">-out</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">tls.crt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">kubectl</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">create</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">secret</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">tls</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">auth-credentials</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--cert=tls.crt</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--key=tls.key</span></span></code></pre>
<p>Once our <code>auth-credentials</code> secret has been configured, we can deploy the docker-auth system.
For this example, we’re going to restrict anonymous pulls to a DockerHub user or group of our choosing (<code>DOCKERHUB_ALLOWED</code>).
This means that users who are unauthenticated will only be allowed to pull images from these specified groups.
For this, you will need <a href="https://gist.github.com/mjpitz/53e1d92cb0f2dc68e06e5c405f67e04f#file-02-docker-auth-values-yaml">02-docker-auth-values.yaml</a> from the gist.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">git</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">clone</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">https://github.com/cesanta/docker_auth.git</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">upgrade</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-i</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">docker-auth</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">./docker_auth/chart/docker-auth</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">-f</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">02</span><span style="color: #9ECBFF">-docker-auth-values.yaml</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configmap.data.acl[</span><span style="color: #79B8FF">0</span><span style="color: #9ECBFF">].match.name="${</span><span style="color: #E1E4E8">DOCKERHUB_ALLOWED</span><span style="color: #9ECBFF">}/*"</span><span style="color: #E1E4E8"> </span></span></code></pre>
<p>Once running, you should be able to issue <code>/auth</code> requests against the pod.
The endpoint should return a pair of tokens that represent an unauthenticated user.</p>
<h3 id="deploy-an-ingress">Deploy an ingress</h3>
<p>Now that both docker-registry and docker-auth are running, let’s connect them.
In kubernetes, an <code>Ingress</code> is a great way to provide application layer (L7) routing to applications.
It supports both host and path based routing.
In this post we’ll configure the paths of an ingress to route to their appropriate backend.
<code>/auth</code>, <code>/google_auth</code>, and <code>/github_auth</code> will all route to the docker-auth project.
<code>/v2</code> will route to the docker-registry project.
To do this, we will need <a href="https://gist.github.com/mjpitz/53e1d92cb0f2dc68e06e5c405f67e04f#file-03-ingress-yaml">03-ingress.yaml</a> from the gist.
Be sure to change the <code>host</code> to your project domain.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">kubectl</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">apply</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-f</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">03</span><span style="color: #9ECBFF">-ingress.yaml</span></span></code></pre>
<p>Once applied, you should be able to start working with the ingress definition.
Requests to <code>/auth</code> should resolve from docker-auth.
Requests to <code>/v2/_catalog</code> should resolve from docker-registry.
Remember, some annotations on the ingress are specific to my tech stack.
You may need to find the equivalent for yours.</p>
<h3 id="connecting-docker-registry-to-docker-auth">Connecting docker-registry to docker-auth</h3>
<p>Now that the client can speak to docker-auth and docker-registry, we can connect the two.
To do so, the docker-registry needs access to the certificate used by docker-auth.
This is used to validate the JWT token.
We can update <code>docker-registry-values.yaml</code> to volume mount the file in.
Then, we just need to point the <code>auth</code> block of configuration at the proper endpoints.
Below is a diff of the changes needed to add auth.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">    encrypt: false</span></span>
<span class="line"><span style="color: #E1E4E8">    securet: true</span></span>
<span class="line"><span style="color: #E1E4E8">  </span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> extraVolumeMounts:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>   - name: auth</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>     mountPath: "/etc/docker-auth/ssl/"</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>     readOnly: true</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> </span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> extraVolumes:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>   - name: auth</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>     secret:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>       secretName: auth-credentials</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> </span></span>
<span class="line"><span style="color: #E1E4E8">  # see https://docs.docker.com/registry/configuration/</span></span>
<span class="line"><span style="color: #E1E4E8">  configData:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>   auth:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>     token:</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>       realm: "https://ocr.sh/auth"</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>       service: "ocr.sh"</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>       issuer: "My Auth" # must match issuer from docker-auth</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>       rootcertbundle: /etc/docker-auth/ssl/tls.crt</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> </span></span>
<span class="line"><span style="color: #E1E4E8">    http:</span></span>
<span class="line"><span style="color: #E1E4E8">      addr: :5000</span></span>
<span class="line"><span style="color: #E1E4E8">      debug:</span></span></code></pre>
<p>Alternatively, you can grab an updated copy from <a href="https://gist.github.com/mjpitz/53e1d92cb0f2dc68e06e5c405f67e04f#file-04-docker-registry-values-yaml">04-docker-registry-values-yaml</a> in the gist.
Remember to set your <code>realm</code>, <code>service</code>, <code>issuer</code> and <code>rootcertbundle</code> appropriately.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">helm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">upgrade</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-i</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">docker-registry</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">stable/docker-registry</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--version</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1.9</span><span style="color: #9ECBFF">.4</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">-f</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">04</span><span style="color: #9ECBFF">-docker-registry-values.yaml</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">secrets.s3.accessKey=</span><span style="color: #E1E4E8">${AWS_ACCESS_KEY_ID} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">secrets.s3.secretKey=</span><span style="color: #E1E4E8">${AWS_SECRET_ACCESS_KEY} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.region=</span><span style="color: #E1E4E8">${S3_REGION} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.regionEndpoint=</span><span style="color: #E1E4E8">${S3_ENDPOINT} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">s3.bucket=</span><span style="color: #E1E4E8">${S3_BUCKET} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.redis.password=</span><span style="color: #E1E4E8">${REDIS_PASSWORD} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.proxy.username=</span><span style="color: #E1E4E8">${DOCKERHUB_USERNAME} </span><span style="color: #79B8FF">\</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">--set</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">configData.proxy.password=</span><span style="color: #E1E4E8">${DOCKERHUB_ACCESS_TOKEN}</span></span></code></pre>
<p>Once your release has been upgraded, the registry should deny any requests for images outside of your configured group.
For example, I wound up with <code>ocr.sh</code> for my projects domain.
I configured <code>DOCKERHUB_ALLOWED</code> to only allow unauthenticated users to pull <code>depscloud/*</code>.
This allows my project consumers to continue to use my product without being rate limited by GitHub.
Under the hood, all requests to DockerHub are authenticated.
In addition to that, I have tight control over what repositories I allow to be pulled through my proxy.</p>
<p>Thanks for reading!
I hope you learned something by stopping by and reading this post.</p></div></article></main><footer data-astro-cid-sz7xmlte>
&copy; 2023&nbsp;Mya Pitzeruse. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-sz7xmlte></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-sz7xmlte></path></svg></a></div></footer></body></html>