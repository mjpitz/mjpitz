<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo><head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.0.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mya.sh/blog/2020/08/06/bfs-over-grpc-stream/"><!-- Primary Meta Tags --><title>Implementing Breadth-first Search Over gRPC</title><meta name="title" content="Implementing Breadth-first Search Over gRPC"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mya.sh/blog/2020/08/06/bfs-over-grpc-stream/"><meta property="og:title" content="Implementing Breadth-first Search Over gRPC"><meta property="og:description" content=""><meta property="og:image" content="https://mya.sh/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mya.sh/blog/2020/08/06/bfs-over-grpc-stream/"><meta property="twitter:title" content="Implementing Breadth-first Search Over gRPC"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mya.sh/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/_...slug_.e98600b1.css" />
<style type="text/css">main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:var(--color-text)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head><body data-astro-cid-bvzihdzo><header data-astro-cid-3ef6ksr2><nav data-astro-cid-3ef6ksr2><div class="theme-switch-wrapper"><label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox"><div class="slider"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div></label></div><h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mya Pitzeruse</a></h2><div class="internal-links" data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Home</a><a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Blog</a><a href="/charts" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Charts</a><a href="/media" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Media</a><a href="/hockey" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Hockey</a></div><div class="social-links" data-astro-cid-3ef6ksr2><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-3ef6ksr2></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-3ef6ksr2></path></svg></a></div></nav></header><main data-astro-cid-bvzihdzo><article data-astro-cid-bvzihdzo><div class="hero-image" data-astro-cid-bvzihdzo><img width="1020" height="510" src="/img/blog-placeholder-4.jpg" alt="" data-astro-cid-bvzihdzo></div><div class="prose" data-astro-cid-bvzihdzo><div class="title" data-astro-cid-bvzihdzo><div class="date" data-astro-cid-bvzihdzo><time datetime="2020-08-06T00:00:00.000Z">Aug 6, 2020</time></div><h1 data-astro-cid-bvzihdzo>Implementing Breadth-first Search Over gRPC</h1><hr data-astro-cid-bvzihdzo></div><p><a href="https://deps.cloud">deps.cloud</a> is an open source project that I started.
It’s a tool that helps companies understand how their projects relate to one another.
It does this by parsing files like <code>package.json</code> and storing the contents in a <a href="https://en.wikipedia.org/wiki/Graph_(abstract_data_type)">graph</a>.</p>
<p>While <a href="https://en.wikipedia.org/wiki/Graph_database">graph databases</a> do exist, finding administrative and engineering support is often hard.
To add complexity to this, graph databases come in a variety of flavors.
Since I wanted the workload to be portable, adopting a graph database was a non-starter.</p>
<p>On the other hand, finding support for relational databases is easy.
The problem is that implementing graphs on relational databases tend to be slow.
While there has been previous efforts, I felt <a href="https://grpc.io">gRPC</a> was able to alleviate many of the problems they faced.
In this post, I share lessons I learned while implementing such a graph database.</p>
<!--more-->
<h2 id="the-database-schema">The Database Schema</h2>
<p>Before talking about the service layer, we first need to cover how we store data.
A common approach is to separate the data out into two separate tables.
One table stores the <code>nodes</code>, or entities, of the graph.
The other stores the <code>edges</code>, or associations.
The problem with this approach is that it often complicates the query logic.
In order to get a full picture, you need to join across 3 tables (<code>nodes</code>, <code>edges</code>, and <code>nodes</code> again).</p>
<p>Instead, I decided to store all data (<code>nodes</code> and <code>edges</code>) in a single table.
This was inspired by <a href="https://www.youtube.com/watch?v=VZ-zJEWi-Vo">Dropbox’s EdgeStore</a>.
The schema for <a href="https://www.mysql.com/">MySQL</a> is as follows:</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">CREATE TABLE IF NOT EXISTS graphdata(</span></span>
<span class="line"><span style="color: #e1e4e8">  graph_item_type VARCHAR(55),</span></span>
<span class="line"><span style="color: #e1e4e8">  k1 VARCHAR(64),</span></span>
<span class="line"><span style="color: #e1e4e8">  k2 VARCHAR(64),</span></span>
<span class="line"><span style="color: #e1e4e8">  k3 VARCHAR(64),</span></span>
<span class="line"><span style="color: #e1e4e8">  encoding TINYINT,</span></span>
<span class="line"><span style="color: #e1e4e8">  graph_item_data TEXT,</span></span>
<span class="line"><span style="color: #e1e4e8">  last_modified DATETIME,</span></span>
<span class="line"><span style="color: #e1e4e8">  date_deleted DATETIME DEFAULT NULL,</span></span>
<span class="line"><span style="color: #e1e4e8">  PRIMARY KEY (graph_item_type, k1, k2, k3),</span></span>
<span class="line"><span style="color: #e1e4e8">  KEY secondary (graph_item_type, k2, k1, k3),</span></span>
<span class="line"><span style="color: #e1e4e8">  KEY (date_deleted)</span></span>
<span class="line"><span style="color: #e1e4e8">);</span></span></code></pre>
<ol>
<li>When <code>k1 == k2</code>, the row is a node.</li>
<li>When <code>k1 != k2</code>, the row is an edge.</li>
<li>The <code>k3</code> field allows nodes to have multiple edges between them.</li>
<li>Keys have a maximum length to keep the index small.</li>
<li>The <code>secondary</code> key improves performance of queries in the inverse direction.</li>
</ol>
<h2 id="service-definitions">Service Definitions</h2>
<p>Early on, I wanted a very straight forward interface.
In some of my previous work, the data felt more like key/value data.
I often used bulk updates or bulk deletes to manage my information.
Scanning the data was a semi-common task.
Finally, I needed to do prefix scans on both indexes.
That is:</p>
<ul>
<li><code>k1, k2</code> when querying for the egress (upstream) edges.</li>
<li><code>k2, k1</code> when querying for the ingress (downstream) edges.</li>
</ul>
<p>As a result, I wound up with a pretty minimal key/value interface.
While small, it provides the necessary building blocks for other calls.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PutRequest</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PutResponse</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DeleteRequest</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DeleteResponse</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ListRequest</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ListResponse</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">FindRequest</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">FindResponse</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">service</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GraphStore</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Put</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">PutRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">PutResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Delete</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DeleteRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">DeleteResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">List</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ListRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">ListResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// neighbors</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">FindUpstream</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">FindRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FindResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">FindDownstream</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">FindRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FindResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>In addition to the key/value interface, I needed away to query the graph efficiently.
I started by implementing topological sorting as a client-only feature.
The problem was this required constant communication between the client and server.
This pushed me more towards a stream-based API.
gRPC provides three different types of streaming calls:</p>
<ol>
<li>Client (eg. file upload)</li>
<li>Server (eg. file download)</li>
<li>Bidirectional (eg. chat app)</li>
</ol>
<p>For this use case, either a server or bidirectional streaming API would work.
The main goal is to reduce the amount of back and forth between the clients.
In many traversal algorithms you usually start with a set of nodes, and a strategy to apply.</p>
<p>For example, consider <a href="https://en.wikipedia.org/wiki/Breadth-first_search">breadth-first search</a>.
Engineers often use it to navigate <a href="https://en.wikipedia.org/wiki/Tree_(data_structure)">tree</a> and graph based data structures.
It works by taking a starting node, traversing its children, and repeating the process for each child.
What we see here is that we start with a single request that quickly turns into a lot of data.
Hence, the server streaming capability.</p>
<p>In my implementation, I chose a bidirectional stream.
The reason is these search algorithms often terminate early once it finds the node.
I wanted clients to be able to send along a stop request to prevent any further queries.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchRequest</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"><span style="color: #F97583">message</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchResponse</span><span style="color: #E1E4E8"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">service</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchService</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">BreadthFirstSearch</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">stream</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">stream</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">rpc</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DepthFirstSearch</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">stream</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchRequest</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">returns</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">stream</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SearchResponse</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<h2 id="implementing-breadth-first-search">Implementing Breadth-first Search</h2>
<p>In my opinion, breadth-first search is the easier of the two functions.
<a href="https://en.wikipedia.org/wiki/Depth-first_search">Depth-first search</a> requires further conversation around ordering and how that impacts the results.</p>
<p>In this section, I’m going to use an in-memory map to represent the graph.
You can imagine this being swapped out with the <code>GraphStore</code> interface.
Before we introduce streaming concepts to the code, lets start with an iterative BFS.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">package</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">func</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">bfs</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">	graph </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">map</span><span style="color: #E1E4E8">[</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">][]</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"a"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"b"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"b"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"d"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"e"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #6A737D">// ....</span></span>
<span class="line"><span style="color: #E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">	current </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> []</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">{</span><span style="color: #9ECBFF">"a"</span><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #E1E4E8">	results </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">make</span><span style="color: #E1E4E8">([]</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">	</span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> length </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(current); length </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">; length </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(current) {</span></span>
<span class="line"><span style="color: #E1E4E8">		next </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">make</span><span style="color: #E1E4E8">([]</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> _, node </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">range</span><span style="color: #E1E4E8"> current {</span></span>
<span class="line"><span style="color: #E1E4E8">			next </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">append</span><span style="color: #E1E4E8">(next, graph[node]</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">		results </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">append</span><span style="color: #E1E4E8">(results, current</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		current </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> next</span></span>
<span class="line"><span style="color: #E1E4E8">	}</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>An iterative solution is key here.
It allows you to buffer and discard layers, thus keeping memory requirements low.
While there are a few inefficiencies in the code, it illustrates the overall structure.
Next, we can introduce the streaming concepts.
In introducing these, we no longer need to track the <code>results</code> of a function.
Instead, we can write the current tier out to the client as we go.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">package</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">type</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ServerStreamingCall</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">interface</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">	</span><span style="color: #79B8FF">Send</span><span style="color: #E1E4E8">(response </span><span style="color: #F97583">string</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">error</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">func</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">bfs</span><span style="color: #E1E4E8">(call ServerStreamingCall) {</span></span>
<span class="line"><span style="color: #E1E4E8">	graph </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">map</span><span style="color: #E1E4E8">[</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">][]</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"a"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"b"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"b"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"d"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #9ECBFF">"c"</span><span style="color: #E1E4E8">: {</span><span style="color: #9ECBFF">"e"</span><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #6A737D">// ....</span></span>
<span class="line"><span style="color: #E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">	current </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> []</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">{</span><span style="color: #9ECBFF">"a"</span><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">	</span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> length </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(current); length </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">; length </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(current) {</span></span>
<span class="line"><span style="color: #E1E4E8">		next </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">make</span><span style="color: #E1E4E8">([]</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> _, node </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">range</span><span style="color: #E1E4E8"> current {</span></span>
<span class="line"><span style="color: #E1E4E8">			next </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">append</span><span style="color: #E1E4E8">(next, graph[node]</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #6A737D">// flush result to client</span></span>
<span class="line"><span style="color: #E1E4E8">            _ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> call.</span><span style="color: #79B8FF">Send</span><span style="color: #E1E4E8">(node)</span></span>
<span class="line"><span style="color: #E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">		current </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> next</span></span>
<span class="line"><span style="color: #E1E4E8">	}</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>Unlike many previous implementations, this allows the server to progressively navigate the graph.
It keeps server foot prints low, and requires clients to size accordingly for their query.
It improves the latency of calls by reducing round trips between clients and servers.
The was just first pass at implementing such a service.
Throughout the process, I’ve come up other ways to continue improve the performance.
All in all, I’m excited to see how these types of operations scale as the amount of data stored grows.</p></div></article></main><footer data-astro-cid-sz7xmlte>
&copy; 2024&nbsp;Mya Pitzeruse. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-sz7xmlte></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-sz7xmlte></path></svg></a></div></footer></body></html>