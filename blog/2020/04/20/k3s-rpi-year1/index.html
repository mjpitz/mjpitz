<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  class="html"
><head>
    <title>
        
        Mya Pitzeruse
        |
        Home Lab: 1 year later


        


        
    </title>

    
    <meta charset="utf-8" /><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="author" content="Mya Pitzeruse" />
    <meta
            name="description"
            content="
      Mom | Homesteader | Software Engineer


    "
    />
    
    
    
    
    <link
            rel="stylesheet"
            href="/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css"
            integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o="
            crossorigin="anonymous"
            type="text/css"
    />

    

    
    <link
            rel="stylesheet"
            href="/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css"
            integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU="
            crossorigin="anonymous"
            type="text/css"
    />
    
    
    <link
            rel="stylesheet"
            href="/css/overrides.min.2d385947a11fbf61dff71c6e1c2c2efa0a51dcf47be66f416fb97b3cca833a65.css"
            integrity="sha256-LThZR6Efv2Hf9xxuHCwu&#43;gpR3PR75m9Bb7l7PMqDOmU="
            crossorigin="anonymous"
            media="screen"
    />

    
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css"
            integrity="sha256-scTmoQvbqwHzP/&#43;deIFu5oz5qacx8HZor9VGp5kky4A="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css"
            integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css"
            integrity="sha256-t9VBM7J&#43;W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />

    <link rel="canonical" href="https://mjpitz.com/blog/2020/04/20/k3s-rpi-year1/">

    
    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js"
            integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0="
            crossorigin="anonymous"
    ></script>

    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-theme-switcher.min.5557c8ff5617a01067ac258fd70b9b992506e379317b0da51e5e0f6e018b408a.js"
            integrity="sha256-VVfI/1YXoBBnrCWP1wubmSUG43kxew2lHl4PbgGLQIo="
            crossorigin="anonymous"
    ></script>

    

    


    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Home Lab: 1 year later"/>
<meta name="twitter:description" content="Last year, I wrote a series of blog posts covering the set-up of my home lab.
The first post was on my decision to run Rancher&rsquo;s k3s on my Raspberry Pis.
Since then, I&rsquo;ve made a few modifications to how its all managed.
In this post, I discuss some of these changes I made over the last year."/>



    
    <meta property="og:title" content="Home Lab: 1 year later" />
<meta property="og:description" content="Last year, I wrote a series of blog posts covering the set-up of my home lab.
The first post was on my decision to run Rancher&rsquo;s k3s on my Raspberry Pis.
Since then, I&rsquo;ve made a few modifications to how its all managed.
In this post, I discuss some of these changes I made over the last year." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mjpitz.com/blog/2020/04/20/k3s-rpi-year1/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-04-20T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-04-20T00:00:00&#43;00:00" /><meta property="og:site_name" content="Mya Pitzeruse" />




    
    
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "blog",
        "name": "Home Lab: 1 year later",
        "headline": "Home Lab: 1 year later",
        "alternativeHeadline": "",
        "description": "
      
        \u003cp\u003eLast year, I wrote a series of blog posts covering the set-up of my home lab.\nThe \u003ca href=\u0022\/blog\/2019\/04\/10\/k8s-k3s-rpi-oh-my\/\u0022\u003efirst\u003c\/a\u003e post was on my decision to run \u003ca href=\u0022https:\/\/k3s.io\/\u0022\u003eRancher\u0026rsquo;s k3s\u003c\/a\u003e on my \u003ca href=\u0022https:\/\/www.raspberrypi.org\/\u0022\u003eRaspberry Pis\u003c\/a\u003e.\nSince then, I\u0026rsquo;ve made a few modifications to how its all managed.\nIn this post, I discuss some of these changes I made over the last year.\u003c\/p\u003e


      


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mjpitz.com\/blog\/2020\/04\/20\/k3s-rpi-year1\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "creator" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightYear" : "2020",
        "dateCreated": "2020-04-20T00:00:00.00Z",
        "datePublished": "2020-04-20T00:00:00.00Z",
        "dateModified": "2020-04-20T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Mya Pitzeruse",
            "url": "https://mjpitz.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/mjpitz.com\/img\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/mjpitz.com\/blog\/2020\/04\/20\/k3s-rpi-year1\/",
        "wordCount" : "567",
        "genre" : [ ],
        "keywords" : [ 
      
      "software development"

    ]
    }
  </script>



</head>
<body
    
      class="body theme--light"

    
  >
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"

        
      ><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/img/mjpitz.jpeg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Mya Pitzeruse</a>
        </div>

      
      <div class="sidebar__introduction-description">
        <p>Mom | Homesteader | Software Engineer</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/mjpitz"
            target="_blank"
            rel="noopener"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/mjpitz/"
            target="_blank"
            rel="noopener"
            aria-label="LinkedIn"
            title="LinkedIn"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="/index.xml"
            target="_blank"
            rel="noopener"
            aria-label="Feed"
            title="Feed"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer__sidebar">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"

        
      >
        <header class="header"><div
  class="
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
      
        
        
          <li class="nav__list-item">
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/blog/"
              
              title=""
              >Blog</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/charts/"
              
              title=""
              >Charts</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/media/"
              
              title=""
              >Media</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/papers/"
              
              title=""
              >Papers</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/projects/"
              
              title=""
              >Projects</a
            >
          </li>

        


      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>

      
    </ul>
  </nav>
</div>
</header>
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h3>Home Lab: 1 year later</h3>
        
        <div class="info">
          <i class="fa fa-sun-o"></i><span class="date">Mon, Apr 20, 2020</span>
          <i class="fa fa-clock-o"></i><span class="reading-time">3-minute read</span>
        </div>
        
        </div>

    <p>Last year, I wrote a series of blog posts covering the set-up of my home lab.
The <a href="/blog/2019/04/10/k8s-k3s-rpi-oh-my/">first</a> post was on my decision to run <a href="https://k3s.io/">Rancher&rsquo;s k3s</a> on my <a href="https://www.raspberrypi.org/">Raspberry Pis</a>.
Since then, I&rsquo;ve made a few modifications to how its all managed.
In this post, I discuss some of these changes I made over the last year.</p>
<h2 id="from-terraform-to-cloud-init">From terraform to cloud-init</h2>
<p>I used to use terraform to manage my raspberry pis.
While it accomplished the job, I felt it was overkill for what I needed it to do.
In this pass, I started by looking at the <code>system-boot</code> partition of an Ubuntu install.
It was in there, that I found ways to hook into things like Netplan and cloud-init.
This gave me a great step forward to codifying my home lab set-up with a declarative model.</p>
<p><a href="https://github.com/mjpitz/rpi-cloud-init">https://github.com/mjpitz/rpi-cloud-init</a></p>
<h2 id="no-more-pets">No more pets</h2>
<p>I used to name my clusters something cute, usually based off of a synonym.
Gone are the days of <code>myriad</code>, <code>horde</code>, <code>hive</code>, and <code>hub</code>.
Now, I use hostnames that resemble the AWS convention.
That is, <code>ip-192-168-1-xyz</code> for the <code>192.168.1.0/24</code> range.</p>
<p>I still wrangle all of my machines using <code>docker-machine</code>.
It affords me a few conveniences.
One, I can easily connect to remote docker agents using <code>docker-machine env</code>.
This allows me to inspect containers without needing to jump to the box.
Should further inspection be needed, I can easily jump to the host using <code>docker-machine ssh</code>.</p>
<p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggTFJcbiAgTGFwdG9wIC0tLXxjb25uZWN0IHZpYSBkb2NrZXItbWFjaGluZXwgaXAtMTkyLTE2OC0xLXh5eiIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggTFJcbiAgTGFwdG9wIC0tLXxjb25uZWN0IHZpYSBkb2NrZXItbWFjaGluZXwgaXAtMTkyLTE2OC0xLXh5eiIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9" alt=""></a></p>
<h2 id="home-cloud">Home cloud</h2>
<p>To make the most out of my set-up, I wanted to structure it based on a cloud.
While I can&rsquo;t have the exact set-up as a cloud provider, I can get pretty close.
Each &ldquo;availability zone&rdquo; consists of:</p>
<ul>
<li>an independent power supply</li>
<li>a single, raspberry pi 4 (control plane)</li>
<li>four, raspberry pi 3b+ (worker)</li>
</ul>
<p>Three of these &ldquo;availability zones&rdquo; compose a single &ldquo;region&rdquo;.
Since I&rsquo;m based out of us-central, I figured it would be a good starting point.</p>
<p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcbiAgdXMtY2VudHJhbC0xW3JlZ2lvbjp1cy1jZW50cmFsLTFdXG4gIHVzLWNlbnRyYWwtMWFbem9uZTp1cy1jZW50cmFsLTFhXVxuICB1cy1jZW50cmFsLTFiW3pvbmU6dXMtY2VudHJhbC0xYl1cbiAgdXMtY2VudHJhbC0xY1t6b25lOnVzLWNlbnRyYWwtMWNdXG4gIFxuICB1cy1jZW50cmFsLTEgLS0-IHVzLWNlbnRyYWwtMWFcbiAgdXMtY2VudHJhbC0xIC0tPiB1cy1jZW50cmFsLTFiXG4gIHVzLWNlbnRyYWwtMSAtLT4gdXMtY2VudHJhbC0xYyAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgdXMtY2VudHJhbC0xW3JlZ2lvbjp1cy1jZW50cmFsLTFdXG4gIHVzLWNlbnRyYWwtMWFbem9uZTp1cy1jZW50cmFsLTFhXVxuICB1cy1jZW50cmFsLTFiW3pvbmU6dXMtY2VudHJhbC0xYl1cbiAgdXMtY2VudHJhbC0xY1t6b25lOnVzLWNlbnRyYWwtMWNdXG4gIFxuICB1cy1jZW50cmFsLTEgLS0-IHVzLWNlbnRyYWwtMWFcbiAgdXMtY2VudHJhbC0xIC0tPiB1cy1jZW50cmFsLTFiXG4gIHVzLWNlbnRyYWwtMSAtLT4gdXMtY2VudHJhbC0xYyAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ" alt=""></a></p>
<p>For simplicity, each zone is allocated a designated CIDR block.</p>
<ul>
<li><code>us-central-1a</code> is allocated <code>192.168.1.50/29</code></li>
<li><code>us-central-1b</code> is allocated <code>192.168.1.60/29</code></li>
<li><code>us-central-1c</code> is allocated <code>192.168.1.70/29</code></li>
</ul>
<h2 id="deploying-k3s">Deploying k3s</h2>
<p>Ever since switching to k3s, I haven&rsquo;t needed any other tool.
My deployment of it hasn&rsquo;t changed too much.
I continue to run the k3s agent through docker.
One thing I do differently is pass in the appropriate topology flags.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  docker run -d <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    ... <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    --node-label <span style="color:#4e9a06">&#34;node.kubernetes.io/instance-type=rpi-4&#34;</span> <span style="color:#4e9a06">\ </span>
    --node-label <span style="color:#4e9a06">&#34;topology.kubernetes.io/region=us-central-1&#34;</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    --node-label <span style="color:#4e9a06">&#34;topology.kubernetes.io/zone=us-central-1a&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>From a development standpoint, there is a lot of benefit to having this information surfaced.
You can test the spread of stateful workloads, enforce communication between services and geographical boundaries.
One thing it affords me is the ability to test and leverage <a href="https://imroc.io/posts/kubernetes/service-topology-en/">topology-aware service routing</a>.</p>
<h2 id="leveraging-gitops">Leveraging GitOps</h2>
<p>The last big change that I&rsquo;ve made has been moving to a declarative deployment model for common elements.
Instead of running my monitoring infrastructure outside of the cluster, I now run it inside of it.
I do this through the use of a GitOps based deployment model.
GitOps has become a popular way to perform declarative deployments using a Git repository as a source of truth.</p>
<p>To get started, I configured a repository with some common infrastructural elements.
This repository is then synchronized with the cluster using tools like <a href="https://github.com/fluxcd/flux">Flux</a>.
To simplify the manifests deployed to the cluster, I leverage the <a href="https://github.com/fluxcd/helm-operator">helm-operator</a>.
This allows me to easily deploy <a href="https://helm.sh/">Helm</a> charts into the cluster with the use of a single custom resource.</p>
    </div>
    <div class="post-footer">
      <div class="info">
        
        <span><a class="tag" href="/tags/software-development/">software development</a></span>


      </div>
    </div>

    
</div>


      </main>
    </div><footer class="footer footer__base">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></body>
</html>
