<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.4.4"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mya.sh/blog/2020/04/20/k3s-rpi-year1/"><!-- Primary Meta Tags --><title>Home Lab: 1 year later</title><meta name="title" content="Home Lab: 1 year later"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mya.sh/blog/2020/04/20/k3s-rpi-year1/"><meta property="og:title" content="Home Lab: 1 year later"><meta property="og:description" content=""><meta property="og:image" content="https://mya.sh/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mya.sh/blog/2020/04/20/k3s-rpi-year1/"><meta property="twitter:title" content="Home Lab: 1 year later"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mya.sh/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/_slug_.Cy_hegJV.css" />
<style>main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:var(--color-text)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="theme-switch-wrapper"> <label class="theme-switch" for="checkbox"> <input type="checkbox" id="checkbox"> <div class="slider"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </div> </label>  </div> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mya Pitzeruse</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blog </a>  <a href="/charts" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Charts </a>  <a href="/media" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Media </a>  <a href="/hockey" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Hockey </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/img/blog-placeholder-3.jpg" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2020-04-20T00:00:00.000Z"> Apr 20, 2020 </time>  </div> <h1 data-astro-cid-bvzihdzo>Home Lab: 1 year later</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>Last year, I wrote a series of blog posts covering the set-up of my home lab.
The <a href="/blog/2019/04/10/k8s-k3s-rpi-oh-my/">first</a> post was on my decision to run <a href="https://k3s.io/">Rancher’s k3s</a> on my <a href="https://www.raspberrypi.org/">Raspberry Pis</a>.
Since then, I’ve made a few modifications to how its all managed.
In this post, I discuss some of these changes I made over the last year.</p>
<!--more-->
<h2 id="from-terraform-to-cloud-init">From terraform to cloud-init</h2>
<p>I used to use terraform to manage my raspberry pis.
While it accomplished the job, I felt it was overkill for what I needed it to do.
In this pass, I started by looking at the <code>system-boot</code> partition of an Ubuntu install.
It was in there, that I found ways to hook into things like Netplan and cloud-init.
This gave me a great step forward to codifying my home lab set-up with a declarative model.</p>
<p><a href="https://github.com/mjpitz/rpi-cloud-init">https://github.com/mjpitz/rpi-cloud-init</a></p>
<h2 id="no-more-pets">No more pets</h2>
<p>I used to name my clusters something cute, usually based off of a synonym.
Gone are the days of <code>myriad</code>, <code>horde</code>, <code>hive</code>, and <code>hub</code>.
Now, I use hostnames that resemble the AWS convention.
That is, <code>ip-192-168-1-xyz</code> for the <code>192.168.1.0/24</code> range.</p>
<p>I still wrangle all of my machines using <code>docker-machine</code>.
It affords me a few conveniences.
One, I can easily connect to remote docker agents using <code>docker-machine env</code>.
This allows me to inspect containers without needing to jump to the box.
Should further inspection be needed, I can easily jump to the host using <code>docker-machine ssh</code>.</p>
<p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggTFJcbiAgTGFwdG9wIC0tLXxjb25uZWN0IHZpYSBkb2NrZXItbWFjaGluZXwgaXAtMTkyLTE2OC0xLXh5eiIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggTFJcbiAgTGFwdG9wIC0tLXxjb25uZWN0IHZpYSBkb2NrZXItbWFjaGluZXwgaXAtMTkyLTE2OC0xLXh5eiIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9" alt=""></a></p>
<h2 id="home-cloud">Home cloud</h2>
<p>To make the most out of my set-up, I wanted to structure it based on a cloud.
While I can’t have the exact set-up as a cloud provider, I can get pretty close.
Each “availability zone” consists of:</p>
<ul>
<li>an independent power supply</li>
<li>a single, raspberry pi 4 (control plane)</li>
<li>four, raspberry pi 3b+ (worker)</li>
</ul>
<p>Three of these “availability zones” compose a single “region”.
Since I’m based out of us-central, I figured it would be a good starting point.</p>
<p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcbiAgdXMtY2VudHJhbC0xW3JlZ2lvbjp1cy1jZW50cmFsLTFdXG4gIHVzLWNlbnRyYWwtMWFbem9uZTp1cy1jZW50cmFsLTFhXVxuICB1cy1jZW50cmFsLTFiW3pvbmU6dXMtY2VudHJhbC0xYl1cbiAgdXMtY2VudHJhbC0xY1t6b25lOnVzLWNlbnRyYWwtMWNdXG4gIFxuICB1cy1jZW50cmFsLTEgLS0-IHVzLWNlbnRyYWwtMWFcbiAgdXMtY2VudHJhbC0xIC0tPiB1cy1jZW50cmFsLTFiXG4gIHVzLWNlbnRyYWwtMSAtLT4gdXMtY2VudHJhbC0xYyAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgdXMtY2VudHJhbC0xW3JlZ2lvbjp1cy1jZW50cmFsLTFdXG4gIHVzLWNlbnRyYWwtMWFbem9uZTp1cy1jZW50cmFsLTFhXVxuICB1cy1jZW50cmFsLTFiW3pvbmU6dXMtY2VudHJhbC0xYl1cbiAgdXMtY2VudHJhbC0xY1t6b25lOnVzLWNlbnRyYWwtMWNdXG4gIFxuICB1cy1jZW50cmFsLTEgLS0-IHVzLWNlbnRyYWwtMWFcbiAgdXMtY2VudHJhbC0xIC0tPiB1cy1jZW50cmFsLTFiXG4gIHVzLWNlbnRyYWwtMSAtLT4gdXMtY2VudHJhbC0xYyAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ" alt=""></a></p>
<p>For simplicity, each zone is allocated a designated CIDR block.</p>
<ul>
<li><code>us-central-1a</code> is allocated <code>192.168.1.50/29</code></li>
<li><code>us-central-1b</code> is allocated <code>192.168.1.60/29</code></li>
<li><code>us-central-1c</code> is allocated <code>192.168.1.70/29</code></li>
</ul>
<h2 id="deploying-k3s">Deploying k3s</h2>
<p>Ever since switching to k3s, I haven’t needed any other tool.
My deployment of it hasn’t changed too much.
I continue to run the k3s agent through docker.
One thing I do differently is pass in the appropriate topology flags.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">  docker</span><span style="color:#9ECBFF"> run</span><span style="color:#79B8FF"> -d</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">    ...</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --node-label</span><span style="color:#9ECBFF"> "node.kubernetes.io/instance-type=rpi-4"</span><span style="color:#79B8FF"> \ </span></span>
<span class="line"><span style="color:#B392F0">    --node-label</span><span style="color:#9ECBFF"> "topology.kubernetes.io/region=us-central-1"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --node-label</span><span style="color:#9ECBFF"> "topology.kubernetes.io/zone=us-central-1a"</span></span></code></pre>
<p>From a development standpoint, there is a lot of benefit to having this information surfaced.
You can test the spread of stateful workloads, enforce communication between services and geographical boundaries.
One thing it affords me is the ability to test and leverage <a href="https://imroc.io/posts/kubernetes/service-topology-en/">topology-aware service routing</a>.</p>
<h2 id="leveraging-gitops">Leveraging GitOps</h2>
<p>The last big change that I’ve made has been moving to a declarative deployment model for common elements.
Instead of running my monitoring infrastructure outside of the cluster, I now run it inside of it.
I do this through the use of a GitOps based deployment model.
GitOps has become a popular way to perform declarative deployments using a Git repository as a source of truth.</p>
<p>To get started, I configured a repository with some common infrastructural elements.
This repository is then synchronized with the cluster using tools like <a href="https://github.com/fluxcd/flux">Flux</a>.
To simplify the manifests deployed to the cluster, I leverage the <a href="https://github.com/fluxcd/helm-operator">helm-operator</a>.
This allows me to easily deploy <a href="https://helm.sh/">Helm</a> charts into the cluster with the use of a single custom resource.</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024&nbsp;Mya Pitzeruse. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>