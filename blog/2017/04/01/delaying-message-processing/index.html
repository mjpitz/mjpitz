<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  class="html"
><head>
    <title>
        
        Mya Pitzeruse
        |
        Delaying Asynchronous Message Processing


        


        
    </title>

    
    <meta charset="utf-8" /><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="author" content="Mya Pitzeruse" />
    <meta
            name="description"
            content="
      Mom | Homesteader | Software Engineer


    "
    />
    
    
    
    
    <link
            rel="stylesheet"
            href="/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css"
            integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o="
            crossorigin="anonymous"
            type="text/css"
    />

    

    
    <link
            rel="stylesheet"
            href="/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css"
            integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU="
            crossorigin="anonymous"
            type="text/css"
    />
    
    
    <link
            rel="stylesheet"
            href="/css/overrides.min.2d385947a11fbf61dff71c6e1c2c2efa0a51dcf47be66f416fb97b3cca833a65.css"
            integrity="sha256-LThZR6Efv2Hf9xxuHCwu&#43;gpR3PR75m9Bb7l7PMqDOmU="
            crossorigin="anonymous"
            media="screen"
    />

    
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css"
            integrity="sha256-scTmoQvbqwHzP/&#43;deIFu5oz5qacx8HZor9VGp5kky4A="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css"
            integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link
            rel="stylesheet"
            href="/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css"
            integrity="sha256-t9VBM7J&#43;W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc="
            crossorigin="anonymous"
            type="text/css"
    />
    
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />

    <link rel="canonical" href="http://engineering.indeedblog.com/blog/2017/06/delaying-messages/">

    
    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js"
            integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0="
            crossorigin="anonymous"
    ></script>

    
    
    
    <script
            type="text/javascript"
            src="/js/anatole-theme-switcher.min.5557c8ff5617a01067ac258fd70b9b992506e379317b0da51e5e0f6e018b408a.js"
            integrity="sha256-VVfI/1YXoBBnrCWP1wubmSUG43kxew2lHl4PbgGLQIo="
            crossorigin="anonymous"
    ></script>

    

    


    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Delaying Asynchronous Message Processing"/>
<meta name="twitter:description" content="At Indeed, we always consider what’s best for the job seeker.
When a job seeker applies for a job, we want them to have every opportunity to be hired.
It is unacceptable for a job seeker to miss an employment opportunity because their application was waiting to be processed while the employer makes a hire.
The team responsible for handling applies to jobs posted on Indeed maintains service level objectives (SLOs) for application processing time.
We constantly consider better solutions for processing applications and scaling this system."/>



    
    <meta property="og:title" content="Delaying Asynchronous Message Processing" />
<meta property="og:description" content="At Indeed, we always consider what’s best for the job seeker.
When a job seeker applies for a job, we want them to have every opportunity to be hired.
It is unacceptable for a job seeker to miss an employment opportunity because their application was waiting to be processed while the employer makes a hire.
The team responsible for handling applies to jobs posted on Indeed maintains service level objectives (SLOs) for application processing time.
We constantly consider better solutions for processing applications and scaling this system." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mjpitz.com/blog/2017/04/01/delaying-message-processing/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-04-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2017-04-01T00:00:00&#43;00:00" /><meta property="og:site_name" content="Mya Pitzeruse" />




    
    
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "blog",
        "name": "Delaying Asynchronous Message Processing",
        "headline": "Delaying Asynchronous Message Processing",
        "alternativeHeadline": "",
        "description": "
      
        \u003cp\u003eAt Indeed, we always consider what’s best for the job seeker.\nWhen a job seeker applies for a job, we want them to have every opportunity to be hired.\nIt is unacceptable for a job seeker to miss an employment opportunity because their application was waiting to be processed while the employer makes a hire.\nThe team responsible for handling applies to jobs posted on Indeed maintains \u003ca href=\u0022https:\/\/en.wikipedia.org\/wiki\/Service_level_objective\u0022\u003eservice level objectives\u003c\/a\u003e (SLOs) for application processing time.\nWe constantly consider better solutions for processing applications and scaling this system.\u003c\/p\u003e


      


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mjpitz.com\/blog\/2017\/04\/01\/delaying-message-processing\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "creator" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Mya Pitzeruse"
        },
        "copyrightYear" : "2017",
        "dateCreated": "2017-04-01T00:00:00.00Z",
        "datePublished": "2017-04-01T00:00:00.00Z",
        "dateModified": "2017-04-01T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Mya Pitzeruse",
            "url": "https://mjpitz.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/mjpitz.com\/img\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/mjpitz.com\/blog\/2017\/04\/01\/delaying-message-processing\/",
        "wordCount" : "747",
        "genre" : [ ],
        "keywords" : [ 
      
      "software development"

    ]
    }
  </script>



</head>
<body
    
      class="body theme--light"

    
  >
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"

        
      ><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/img/mjpitz.jpeg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Mya Pitzeruse</a>
        </div>

      
      <div class="sidebar__introduction-description">
        <p>Mom | Homesteader | Software Engineer</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/mjpitz"
            target="_blank"
            rel="noopener"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/mjpitz/"
            target="_blank"
            rel="noopener"
            aria-label="LinkedIn"
            title="LinkedIn"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="/index.xml"
            target="_blank"
            rel="noopener"
            aria-label="Feed"
            title="Feed"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer__sidebar">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"

        
      >
        <header class="header"><div
  class="
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
      
        
        
          <li class="nav__list-item">
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/blog/"
              
              title=""
              >Blog</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/charts/"
              
              title=""
              >Charts</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/media/"
              
              title=""
              >Media</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/papers/"
              
              title=""
              >Papers</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="/projects/"
              
              title=""
              >Projects</a
            >
          </li>

        


      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>

      
    </ul>
  </nav>
</div>
</header>
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h3>Delaying Asynchronous Message Processing</h3>
        
        <div class="info">
          <i class="fa fa-sun-o"></i><span class="date">Sat, Apr 1, 2017</span>
          <i class="fa fa-clock-o"></i><span class="reading-time">4-minute read</span>
        </div>
        
        </div>

    <p>At Indeed, we always consider what’s best for the job seeker.
When a job seeker applies for a job, we want them to have every opportunity to be hired.
It is unacceptable for a job seeker to miss an employment opportunity because their application was waiting to be processed while the employer makes a hire.
The team responsible for handling applies to jobs posted on Indeed maintains <a href="https://en.wikipedia.org/wiki/Service_level_objective">service level objectives</a> (SLOs) for application processing time.
We constantly consider better solutions for processing applications and scaling this system.</p>
<p>Indeed first adopted [RabbitMQ] within our <a href="https://engineering.indeedblog.com/talks/get-job-35-million-times-day-using-rabbitmq/">aggregation engine</a> to handle the volume of jobs we process daily.
With this success, we integrated RabbitMQ into other systems, such as our job seeker application processing pipeline.
Today, this pipeline is responsible for processing <strong>more than 1.5 million applications a day</strong>.
Over time, the team needed to implement several resilience patterns around this integration including:</p>
<ul>
<li>Tracing messages from production to consumption</li>
<li>Delaying message processing when expected errors occur</li>
<li>Sending messages that cannot be processed completely to a dead letter queue</li>
</ul>
<h2 id="implementing-a-delay-queue">Implementing a delay queue</h2>
<p>A <strong>delay queue</strong> prolongs message processing by setting a message aside for a set amount of time.
To understand why we implemented this pattern, consider several key behaviors of most messaging systems.
RabbitMQ:</p>
<ul>
<li>Guarantees at least once delivery (some messages can be delivered multiple times)</li>
<li>Allows acknowledgement (ack), negative acknowledgement (nack), or requeue of messages</li>
<li>Requeues messages to the head of the queue, not the end</li>
</ul>
<p>The team implemented a delay queue primarily to deal with the third item.
Since RabbitMQ requeues messages to the head of the queue, the next message your consumer will likely process is the one that just failed.
Although this is a non-issue for a small volume of messages, critical problems occur as the number of unprocessable messages exceeds the number of consumer threads.
Since consumers can’t get past the group of unprocessable messages at the beginning of the queue, messages back up within the cluster.</p>
<p><img src="/img/2017-delayqueue-backup.jpg" alt="message backup"></p>
<p><em>Figure 1. Message backup within the cluster</em></p>
<h2 id="how-it-works">How it works</h2>
<p>While mechanisms such as a dead letter queue allowed us to delay message processing, they often required manual intervention to return a system to a healthy state.
The delay queue pattern allows our systems to continue processing.
Additionally, it requires less work from our first responders (engineers who are <em>&ldquo;on call&rdquo;</em> during business hours to handle production issues), Site Reliability Engineers (SREs), and our operations team.
The following diagram shows the options for a consumer process that encounters an error:</p>
<p><img src="/img/2017-delayqueue.png" alt="delay queue"></p>
<p><em>Figure 2. Asynchronous message consuming system</em></p>
<p>When a consumer encounters an error and cannot process a message, engineers must choose to have the consumer requeue, place into the delayed queue, or deliver to the dead letter queue.
They can make this decision by considering the following questions:</p>
<p><strong>Was the error unexpected?</strong></p>
<p>If your system encounters an unexpected error that is unlikely to happen again, requeue the message.
This gives your system a second chance to process the message.
Requeuing the message is useful when you encounter:</p>
<ul>
<li>Network blips in service communication</li>
<li>A database operation failure caused by a transaction rollback or the inability to obtain a lock</li>
</ul>
<p><strong>Does the dependent system need time to catch up?</strong></p>
<p>If your system encounters an expected error that may require a little time before reprocessing, delay the message.
This allows downstream systems to catch up so the next time you try to process the message, it’s more likely to succeed.
Delaying the message is useful for handling:</p>
<ul>
<li>Database replication lag issues</li>
<li>Consistency issues when working with eventually consistent systems</li>
</ul>
<p><strong>Would you consider the message unprocessable?</strong></p>
<p>If a message is unprocessable, send it to your dead letter queue.
An engineer can then inspect the message and investigate before dropping or manually requeueing it.
A dead letter queue is useful when your system:</p>
<ul>
<li>Expects a message to contain information that is missing</li>
<li>Requires manual inspection of dependent resources before trying to reprocess the message</li>
</ul>
<h2 id="escalation-policy">Escalation policy</h2>
<p>To further increase your system’s resilience, you might establish an escalation policy among the three options.
If a system requests a message to be requeued n times, start to delay the message.
If the message is delayed another m times, send it to your dead letter queue.
That’s what we have done.</p>
<p>This type of policy has reduced the work for our first responders, SREs, and operations team.
We have been able to scale our application processing system as we process more and more candidate applications every day.</p>
    </div>
    <div class="post-footer">
      <div class="info">
        
        <span><a class="tag" href="/tags/software-development/">software development</a></span>


      </div>
    </div>

    
</div>


      </main>
    </div><footer class="footer footer__base">
    <ul class="footer__list">
        <li class="footer__item">
            &copy;
            
            Mya Pitzeruse
            2023


            
        </li>
        
    </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></body>
</html>
