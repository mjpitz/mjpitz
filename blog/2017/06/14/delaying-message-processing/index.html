<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.4.4"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mya.sh/blog/2017/06/14/delaying-message-processing/"><!-- Primary Meta Tags --><title>Delaying Asynchronous Message Processing</title><meta name="title" content="Delaying Asynchronous Message Processing"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mya.sh/blog/2017/06/14/delaying-message-processing/"><meta property="og:title" content="Delaying Asynchronous Message Processing"><meta property="og:description" content=""><meta property="og:image" content="https://mya.sh/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mya.sh/blog/2017/06/14/delaying-message-processing/"><meta property="twitter:title" content="Delaying Asynchronous Message Processing"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mya.sh/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/_slug_.Cy_hegJV.css" />
<style>main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:var(--color-text)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="theme-switch-wrapper"> <label class="theme-switch" for="checkbox"> <input type="checkbox" id="checkbox"> <div class="slider"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </div> </label>  </div> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mya Pitzeruse</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blog </a>  <a href="/charts" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Charts </a>  <a href="/media" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Media </a>  <a href="/hockey" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Hockey </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/img/blog-placeholder-4.jpg" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2017-06-14T00:00:00.000Z"> Jun 14, 2017 </time>  </div> <h1 data-astro-cid-bvzihdzo>Delaying Asynchronous Message Processing</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>At Indeed, we always consider what’s best for the job seeker.
When a job seeker applies for a job, we want them to have every opportunity to be hired.
It is unacceptable for a job seeker to miss an employment opportunity because their application was waiting to be processed while the employer makes a hire.
The team responsible for handling applies to jobs posted on Indeed maintains <a href="https://en.wikipedia.org/wiki/Service_level_objective">service level objectives</a> (SLOs) for application processing time.
We constantly consider better solutions for processing applications and scaling this system.</p>
<!--more-->
<p>Indeed first adopted [RabbitMQ] within our <a href="https://engineering.indeedblog.com/talks/get-job-35-million-times-day-using-rabbitmq/">aggregation engine</a> to handle the volume of jobs we process daily.
With this success, we integrated RabbitMQ into other systems, such as our job seeker application processing pipeline.
Today, this pipeline is responsible for processing <strong>more than 1.5 million applications a day</strong>.
Over time, the team needed to implement several resilience patterns around this integration including:</p>
<ul>
<li>Tracing messages from production to consumption</li>
<li>Delaying message processing when expected errors occur</li>
<li>Sending messages that cannot be processed completely to a dead letter queue</li>
</ul>
<h2 id="implementing-a-delay-queue">Implementing a delay queue</h2>
<p>A <strong>delay queue</strong> prolongs message processing by setting a message aside for a set amount of time.
To understand why we implemented this pattern, consider several key behaviors of most messaging systems.
RabbitMQ:</p>
<ul>
<li>Guarantees at least once delivery (some messages can be delivered multiple times)</li>
<li>Allows acknowledgement (ack), negative acknowledgement (nack), or requeue of messages</li>
<li>Requeues messages to the head of the queue, not the end</li>
</ul>
<p>The team implemented a delay queue primarily to deal with the third item.
Since RabbitMQ requeues messages to the head of the queue, the next message your consumer will likely process is the one that just failed.
Although this is a non-issue for a small volume of messages, critical problems occur as the number of unprocessable messages exceeds the number of consumer threads.
Since consumers can’t get past the group of unprocessable messages at the beginning of the queue, messages back up within the cluster.</p>
<p><img src="/img/2017-delayqueue-backup.jpg" alt="message backup"></p>
<p><em>Figure 1. Message backup within the cluster</em></p>
<h2 id="how-it-works">How it works</h2>
<p>While mechanisms such as a dead letter queue allowed us to delay message processing, they often required manual intervention to return a system to a healthy state.
The delay queue pattern allows our systems to continue processing.
Additionally, it requires less work from our first responders (engineers who are <em>“on call”</em> during business hours to handle production issues), Site Reliability Engineers (SREs), and our operations team.
The following diagram shows the options for a consumer process that encounters an error:</p>
<p><img src="/img/2017-delayqueue.png" alt="delay queue"></p>
<p><em>Figure 2. Asynchronous message consuming system</em></p>
<p>When a consumer encounters an error and cannot process a message, engineers must choose to have the consumer requeue, place into the delayed queue, or deliver to the dead letter queue.
They can make this decision by considering the following questions:</p>
<p><strong>Was the error unexpected?</strong></p>
<p>If your system encounters an unexpected error that is unlikely to happen again, requeue the message.
This gives your system a second chance to process the message.
Requeuing the message is useful when you encounter:</p>
<ul>
<li>Network blips in service communication</li>
<li>A database operation failure caused by a transaction rollback or the inability to obtain a lock</li>
</ul>
<p><strong>Does the dependent system need time to catch up?</strong></p>
<p>If your system encounters an expected error that may require a little time before reprocessing, delay the message.
This allows downstream systems to catch up so the next time you try to process the message, it’s more likely to succeed.
Delaying the message is useful for handling:</p>
<ul>
<li>Database replication lag issues</li>
<li>Consistency issues when working with eventually consistent systems</li>
</ul>
<p><strong>Would you consider the message unprocessable?</strong></p>
<p>If a message is unprocessable, send it to your dead letter queue.
An engineer can then inspect the message and investigate before dropping or manually requeueing it.
A dead letter queue is useful when your system:</p>
<ul>
<li>Expects a message to contain information that is missing</li>
<li>Requires manual inspection of dependent resources before trying to reprocess the message</li>
</ul>
<h2 id="escalation-policy">Escalation policy</h2>
<p>To further increase your system’s resilience, you might establish an escalation policy among the three options.
If a system requests a message to be requeued n times, start to delay the message.
If the message is delayed another m times, send it to your dead letter queue.
That’s what we have done.</p>
<p>This type of policy has reduced the work for our first responders, SREs, and operations team.
We have been able to scale our application processing system as we process more and more candidate applications every day.</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024&nbsp;Mya Pitzeruse. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>