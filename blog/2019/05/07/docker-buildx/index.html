<!DOCTYPE html>
<html lang="en" data-theme="light"><head>
    <title> Mya Pitzeruse | Using docker-buildx for Multi-architecture Containers </title>
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Thoughts, ramblings, and learnings from my adventures in code.">
    
    <link rel="stylesheet" href="https://mjpitz.com/css/style.min.707aa4670276c49b9db4a4ed6b89419c0ed1b4346e2104f50a364aa767d77773.css" integrity="sha256-cHqkZwJ2xJudtKTta4lBnA7RtDRuIQT1CjZKp2fXd3M=" crossorigin="anonymous" type="text/css">
    <link rel="stylesheet" href="https://mjpitz.com/statics/css/overrides.css" type="text/css">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    <link rel="shortcut icon" href="https://mjpitz.com/statics/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://mjpitz.com/statics/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://mjpitz.com/statics/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://mjpitz.com/statics/img/favicon-16x16.png">
    <link rel="canonical" href="https://mjpitz.com/blog/2019/05/07/docker-buildx/">
    
    
    <script type="text/javascript" src="https://mjpitz.com/js/anatole-header.min.3252f25a22b06e9062229fa50b222e04393830ad8260421079b1d55ace7605b3.js" integrity="sha256-MlLyWiKwbpBiIp&#43;lCyIuBDk4MK2CYEIQebHVWs52BbM=" crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using docker-buildx for Multi-architecture Containers"/>
<meta name="twitter:description" content="When you build a container image, it&rsquo;s typically only built for one platform (linux) and one architecture (amd64).
As the Internet of Things continues to grow, the demand for more arm images increased as well.
Traditionally, in order to produce an arm image, you need an arm device to do the build on.
As a result, most projects wind up missing arm support.
BuildKit provides emulation capabilities that support multi-architecture builds.
With BuildKit, you build container images across multiple architectures concurrently.
This core utility backs docker buildx, a multi-architecture build utility for docker.
In this post, I&rsquo;ll discuss why you should produce multi-architecture container images and demonstrate how to use docker buildx to do it."/>

</head>
<body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src="https://mjpitz.com/statics/img/mjpitz.jpeg" alt="profile picture">
        <h3 title=""><a href="/">Mya Pitzeruse</a></h3>
        <div class="description">
          <p>Thoughts, ramblings, and learnings from my adventures in code.</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
        
        <li>
        <a href="https://github.com/mjpitz" rel="me" aria-label="GitHub">
          <i class="fa fa-2x fa-github" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="https://twitter.com/myajpitz" rel="me" aria-label="Twitter">
          <i class="fa fa-2x fa-twitter" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="https://www.linkedin.com/in/mjpitz/" rel="me" aria-label="LinkedIn">
          <i class="fa fa-2x fa-linkedin" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="/index.xml" rel="me" aria-label="Feed">
          <i class="fa fa-2x fa-rss" aria-hidden="true"></i>
        </a>          
        </li>

        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Mya Pitzeruse 2021 </div>
      </div>
    </div>
</div><div class="main">
            <div class="page-top animated fadeInDown">
    <ul class="nav">
        
        
        
        <li><a  href="/" title="">Home</a></li>
        
        
        <li><a  href="/media/" title="">Media</a></li>
        
        
        <li><a  href="/blog/" title="">Blog</a></li>
        
    </ul>
    <div class="themeswitcher">
        <a class="theme-switch" title="Switch Theme">
            <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </a>
    </div>
</div>

            <div class="autopagerize_page_element">
                <div class="content">
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h3>Using docker-buildx for Multi-architecture Containers</h3>
        
        <div class="info">
          <i class="fa fa-sun-o"></i><span class="date">Tue, May 7, 2019</span>
          <i class="fa fa-clock-o"></i><span class="reading-time">3-minute read</span>
        </div>
        
        </div>

    <p>When you build a container image, it&rsquo;s typically only built for one platform (<code>linux</code>) and one architecture (<code>amd64</code>).
As the Internet of Things continues to grow, the demand for more <code>arm</code> images increased as well.
Traditionally, in order to produce an <code>arm</code> image, you need an <code>arm</code> device to do the build on.
As a result, most projects wind up missing <code>arm</code> support.</p>
<p><a href="https://github.com/moby/buildkit">BuildKit</a> provides emulation capabilities that support multi-architecture builds.
With BuildKit, you build container images across multiple architectures concurrently.
This core utility backs <code>docker buildx</code>, a multi-architecture build utility for docker.
In this post, I&rsquo;ll discuss why you should produce multi-architecture container images and demonstrate how to use <code>docker buildx</code> to do it.</p>
<h2 id="why-build-multiple-architectures">Why build multiple architectures?</h2>
<p>There are many good reasons why you should build multi-architecture images for your project.
One of the biggest being that it improves your users experience.
As someone who works across both <code>amd64</code> and <code>arm64</code>, I often struggle to find images supported across both architectures.
As a result, I wind up needing to create my own or rebuilding another to be able to run the system on my cluster.</p>
<p>This makes it more difficult to get started with projects.
Instead of running that <code>kubectl apply -f</code> command I found on the web, I first need to consider:</p>
<ol>
<li>Do the referenced images run on <code>arm64</code>?</li>
<li>If they don&rsquo;t, has someone already ported them?</li>
<li>If someone hasn&rsquo;t ported them, has anyone requested support?</li>
<li>If someone hasn&rsquo;t request support, what happens when I try to compile them?</li>
</ol>
<p>And the list of goes on.
By cross compiling images and leveraging manifest lists, you can create a much better experience for developers on a different architectures.</p>
<h2 id="working-with-buildx">Working with buildx</h2>
<p>In order to get started with <code>buildx</code>, you&rsquo;ll need to install the latest edge version of Docker.</p>
<ul>
<li><a href="https://docs.docker.com/docker-for-mac/edge-release-notes/">Docker Edge for Mac</a></li>
<li><a href="https://docs.docker.com/docker-for-windows/edge-release-notes/">Docker Edge for Windows</a></li>
</ul>
<p>Once the edge version of Docker has been installed, you&rsquo;ll be able to interact with the <code>buildx</code> command.
The first thing you will want to do is create a context for your project.
This acts as a workspace for your current build states.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker buildx create --name <span style="color:#4e9a06">${</span><span style="color:#000">PROJECT</span><span style="color:#4e9a06">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once the context has been created, you&rsquo;ll want to switch to using it.
You can either use the <code>--use</code> option on the <code>create</code> command or explicitly switch contexts using <code>use</code>.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker buildx use <span style="color:#4e9a06">${</span><span style="color:#000">PROJECT</span><span style="color:#4e9a06">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After activating the environment, you&rsquo;re ready to build your image across multiple architectures.
Below, I have provided a simple build command.
This will cause 3 builds to happen: one for <code>linux/amd64</code>, one for <code>linux/arm64</code>, and one for <code>linux/arm/v7</code>.
In addition to that, by providing the <code>-t</code> option, <code>buildx</code> will produce a manifest list containing the layer references for each corresponding architectures.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t <span style="color:#4e9a06">${</span><span style="color:#000">PROJECT</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span> .
</code></pre></td></tr></table>
</div>
</div><p>What this means is that when a user wants to run your project on an ARM system, they no longer need to reference an architecture specific image or tag.
Instead, they are able to use the same image ref and the same tag that they would use on a typical desktop machine.
Once you&rsquo;re satisfied with your build, you can append the <code>--push</code> option to the <code>buildx</code> command to push the images and manifest list upstream.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t <span style="color:#4e9a06">${</span><span style="color:#000">PROJECT</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span> . --push
</code></pre></td></tr></table>
</div>
</div><p>After your images have been successfully pushed, you can see the supported architectures on the tags page of the docker repository.</p>
<p><img src="/statics/img/multiarch-container-image.png" alt="multiarch-container-image.png"></p>
<p>One thing that I&rsquo;ve found frustrating from hub.docker.com is that they don&rsquo;t do a good job calling out to the supported architectures on the public tags page.
This means that image producers need to call out to this support in their README files.
At least for now.</p>
<p><img src="/statics/img/multiarch-container-public.png" alt="multiarch-container-public.png"></p>
    </div>
    <div class="post-footer">
      <div class="info">
        
        
    <span class="separator"><a class="tag" href="/tags/docker/">docker</a><a class="tag" href="/tags/multiarch/">multiarch</a><a class="tag" href="/tags/arm/">arm</a><a class="tag" href="/tags/arm64/">arm64</a><a class="tag" href="/tags/buildx/">buildx</a></span>

      </div>
    </div>

    
</div>


                </div>
            </div>
        </div>
</body>



<script type="text/javascript" src="https://mjpitz.com/js/jquery.min.64d0083866906099f942140bc1c5cba4b1bf65783c52e4a63c5c46bf9dbc41f4.js" integrity="sha256-ZNAIOGaQYJn5QhQLwcXLpLG/ZXg8UuSmPFxGv528QfQ=" crossorigin="anonymous"></script>


<script type="text/javascript" src="https://mjpitz.com/js/jquery.min.64d0083866906099f942140bc1c5cba4b1bf65783c52e4a63c5c46bf9dbc41f4.js" integrity="sha256-ZNAIOGaQYJn5QhQLwcXLpLG/ZXg8UuSmPFxGv528QfQ=" crossorigin="anonymous"></script>

<script type="text/javascript" src="https://mjpitz.com/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js" integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin="anonymous"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-39314903-5', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</html>
</body>

</html>
