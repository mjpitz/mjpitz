<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo><head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.0.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mjpitz.com/blog/2019/04/10/k8s-k3s-rpi-oh-my/"><!-- Primary Meta Tags --><title>k3s on Raspberry Pi</title><meta name="title" content="k3s on Raspberry Pi"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mjpitz.com/blog/2019/04/10/k8s-k3s-rpi-oh-my/"><meta property="og:title" content="k3s on Raspberry Pi"><meta property="og:description" content=""><meta property="og:image" content="https://mjpitz.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mjpitz.com/blog/2019/04/10/k8s-k3s-rpi-oh-my/"><meta property="twitter:title" content="k3s on Raspberry Pi"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mjpitz.com/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/_...slug_.e98600b1.css" />
<style type="text/css">main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:var(--color-text)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head><body data-astro-cid-bvzihdzo><header data-astro-cid-3ef6ksr2><nav data-astro-cid-3ef6ksr2><div class="theme-switch-wrapper"><label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox"><div class="slider"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div></label></div><h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mya Pitzeruse</a></h2><div class="internal-links" data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Home</a><a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Blog</a><a href="/charts" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Charts</a><a href="/media" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Media</a><a href="/papers" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Papers</a></div><div class="social-links" data-astro-cid-3ef6ksr2><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-3ef6ksr2></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-3ef6ksr2></path></svg></a></div></nav></header><main data-astro-cid-bvzihdzo><article data-astro-cid-bvzihdzo><div class="hero-image" data-astro-cid-bvzihdzo><img width="1020" height="510" src="/img/blog-placeholder-3.jpg" alt="" data-astro-cid-bvzihdzo></div><div class="prose" data-astro-cid-bvzihdzo><div class="title" data-astro-cid-bvzihdzo><div class="date" data-astro-cid-bvzihdzo><time datetime="2019-04-10T00:00:00.000Z">Apr 10, 2019</time></div><h1 data-astro-cid-bvzihdzo>k3s on Raspberry Pi</h1><hr data-astro-cid-bvzihdzo></div><p>Over the last few days, I’ve been revisiting <a href="https://kubernetes.io">Kubernetes</a> on my Raspberry Pi cluster.
I hope to share what I learned in the process and some of the tooling that I discovered along the way.</p>
<!--more-->
<p>I first sat down to experiment with Kubernetes back when I first built my cluster.
I don’t recall what guide I was following, so it’s hard to say where things went wrong.
All I can remember was spending several hours working on it, only to end up with a partially functional cluster.
As a result, I threw everything out and switched to running <a href="https://www.nomadproject.io">Nomad</a>.
Running both <a href="https://www.consul.io/">Consul</a> and Nomad wound up taking a fraction of the time.
They required more provisioning compared to Docker Swarm, but it was easy to automate.</p>
<div class="row text-center">
  <div class="col-xs-12 col-sm-1"></div>
  <div class="col-xs-6 col-sm-5">
    <img title="Consul" alt="Consul" src="/img/consul.png">
  </div>
  <div class="col-xs-6 col-sm-5">
    <img title="Nomad" alt="Nomad" src="/img/nomad.png">
  </div>
  <div class="col-xs-12 col-sm-1"></div>
</div>
<p></p>
<p>After working with Swarm and Nomad for a few months, I took a look to see what was new for k8s.
First, I came across <a href="https://github.com/rancher/rke">Rancher’s RKE</a> command line tool.
It makes provisioning production-ready Kubernetes clusters quick and painless.
Since it was configuration driven, I decided to give it a try and see how it ran on the Raspberry Pis.
I was impressed with how easy it was to get everything up and running.
I was able to connect to and interact wtih the cluster without an issue.
One downside was the overhead of some of the integrations.
Many of my nodes were already consuming half their memory, and I needed dedicated etcd and control plane nodes.</p>
<div class="text-center">
  <img title="rancher" alt="Rancher" src="/img/rancher.png">
</div>
<p></p>
<p>I also came across <a href="https://k3s.io/">k3s</a>.
k3s is a lightweight distribution of kubernetes that targets IOT devices.
This was appealing because it is intended to be deployed similar to k8s.
<a href="https://microk8s.io">MicroK8s</a> presented another alternative, but it was intended to run as a single node.
A pocket kubernetes cluster if you will.
Given I was looking for something closer to native k8s, I decided to give k3s a spin.</p>
<h3 id="starting-the-control-plane">Starting the control plane</h3>
<p>After seeing how RKE deployed k8s to the cluster, I decided to try running k3s out of docker.
Typically, I run these processes in systemd but I wanted to consider other alternatives.</p>
<p>k3s control plane requires a docker volume to store the server data.
Once the volume is created, we can run the k3s server process.
Note that in the run command below, I explicitly disable the agent.
The agent requires the <code>--priviledged</code> flag in order to run processes on the host.
The control plane doesn’t require this permission.
As a result, I decided to run them as separate processes.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ docker volume create k3s-control</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">$ docker run -d \</span></span>
<span class="line"><span style="color: #e1e4e8">    --name "k3s-control" \</span></span>
<span class="line"><span style="color: #e1e4e8">    --network "host" \</span></span>
<span class="line"><span style="color: #e1e4e8">    --restart "always" \</span></span>
<span class="line"><span style="color: #e1e4e8">    -e "K3S_CLUSTER_SECRET=&#x3C;YOUR_SECRET_HERE>" \</span></span>
<span class="line"><span style="color: #e1e4e8">    -v "k3s-control:/var/lib/rancher/k3s" \</span></span>
<span class="line"><span style="color: #e1e4e8">    -p "6443:6443" \</span></span>
<span class="line"><span style="color: #e1e4e8">    rancher/k3s:v0.3.0-arm64 \</span></span>
<span class="line"><span style="color: #e1e4e8">    server --disable-agent</span></span></code></pre>
<p></p>
<p>After about 30 seconds, the control plane should be running.
As a part of it’s setup, it writes the kubeconfg out to <code>/etc/rancher/k3s/k3s.yaml</code>.
Using the following <code>docker cp</code> command, you can copy the file from the container and into your local <code>.kube</code> directory.
Once copied, you’ll want to export it so that <code>kubectl</code> can easily interact with the remote control plane.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ docker cp k3s-control:/etc/rancher/k3s/k3s.yaml ~/.kube/k3s</span></span>
<span class="line"><span style="color: #e1e4e8">$ export KUBECONFIG=~/.kube/k3s</span></span></code></pre>
<p></p>
<p><em>NOTE: you will need to modify the extracted kubeconfig file and change ”<a href="https://localhost:6443">https://localhost:6443</a>” to point to the proper host.</em>
<em>In my case, this was ”<a href="https://192.168.1.100:6443">https://192.168.1.100:6443</a>“.</em>
<em>If you do not change this, kubectl cannot communicate with the api-server.</em></p>
<h3 id="starting-the-agents">Starting the agents</h3>
<p>Once the control plane is up and running, we need to add the agents.
Agents are the component of the stack that are responsible for managing the processes running on the host.
As a result, they need to be privileged to spin up containers where needed.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ docker run -d \</span></span>
<span class="line"><span style="color: #e1e4e8">    --name "k3s-exec" \</span></span>
<span class="line"><span style="color: #e1e4e8">    --network "host" \</span></span>
<span class="line"><span style="color: #e1e4e8">    --restart "always" \</span></span>
<span class="line"><span style="color: #e1e4e8">    -e "K3S_CLUSTER_SECRET=&#x3C;YOUR_SECRET_HERE>" \</span></span>
<span class="line"><span style="color: #e1e4e8">    -e "K3S_URL=https://&#x3C;CONTROL_IP>:6443" \</span></span>
<span class="line"><span style="color: #e1e4e8">    --privileged \</span></span>
<span class="line"><span style="color: #e1e4e8">    --tmpfs /run \</span></span>
<span class="line"><span style="color: #e1e4e8">    --tmpfs /var/run \</span></span>
<span class="line"><span style="color: #e1e4e8">    rancher/k3s:v0.3.0-arm64</span></span></code></pre>
<p></p>
<p>The agents should start up quicker compared to the control plane.
You can verify that they connected successfully using kubectl.
Remember, you’ll need to have the <code>KUBECONFIG</code> environment variable exported.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ kubectl get node</span></span>
<span class="line"><span style="color: #e1e4e8">NAME        STATUS    ROLES     AGE       VERSION</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-1    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-10   Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-2    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-3    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-4    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-5    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-6    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-7    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-8    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span>
<span class="line"><span style="color: #e1e4e8">myriad-9    Ready     &#x3C;none>    1d        v1.13.5-k3s.1</span></span></code></pre>
<p></p>
<h3 id="setup-details">Setup Details</h3>
<p>There are a few key details about this setup that are worth noting.</p>
<p><code>--network "host"</code></p>
<p>This flag tells the docker container to leverage the hosts network instead of the bridge provided by docker.
(<a href="https://docs.docker.com/engine/reference/run/#network-settings">Documentation</a>)</p>
<p><code>--restart "always"</code></p>
<p>This flag tells the docker daemon to restart the process regardless of it’s exit status.
For this kind of process, I’d use either <code>always</code> or <code>unless-stopped</code>.
In practice, the container is either present and running or removed so I tend to lean towards <code>always</code>.
(<a href="https://docs.docker.com/engine/reference/run/#restart-policies---restart">Documentation</a>)</p>
<p><code>-e "K3S_CLUSTER_SECRET=&#x3C;YOUR_SECRET_HERE>"</code></p>
<p>This is the shared secret that is used to bootstrap the cluster.
Alternatively, you can set the <code>K3S_TOKEN</code> which is generated by the control plane.
For a quick start, I suggest the cluster secret.
If you’re looking to be able to dynamically add nodes to the cluster, the token is a bit better.</p>
<h2 id="resources">Resources</h2>
<p>In <a href="/blog/2019/03/17/64bit-raspberry-pi/">Easy Steps to a 64bit Raspberry Pi 3 B/B+</a>, I talk about how easy it is to get a 64bit Raspberry Pi up and running.</p>
<p>Since starting my cluster, I’ve been committing the scripts I used to manage it to a <a href="https://github.com/mjpitz/terraform-rpi">repository</a>.
This repository has taken on a few different shapes, but it can be a good reference point for how all of this gets stood up.</p></div></article></main><footer data-astro-cid-sz7xmlte>
&copy; 2023&nbsp;Mya Pitzeruse. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte><a href="https://github.com/mjpitz" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg></a><a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span><svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-sz7xmlte></path></svg></a><a href="/rss.xml" target="_blank" data-astro-cid-sz7xmlte><span class="sr-only" data-astro-cid-sz7xmlte>RSS</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-sz7xmlte></path></svg></a></div></footer></body></html>