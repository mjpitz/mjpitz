<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.13.4"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mya.sh/blog/2019/04/21/monitoring-rpi-cluster/"><!-- Primary Meta Tags --><title>Raspberry Pi Cluster Monitoring | Mya Jaye</title><meta name="title" content="Raspberry Pi Cluster Monitoring | Mya Jaye"><meta name="description" content=""><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mya.sh/blog/2019/04/21/monitoring-rpi-cluster/"><meta property="og:title" content="Raspberry Pi Cluster Monitoring | Mya Jaye"><meta property="og:description" content=""><meta property="og:image" content="https://mya.sh/img/blog-placeholder-5.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mya.sh/blog/2019/04/21/monitoring-rpi-cluster/"><meta property="twitter:title" content="Raspberry Pi Cluster Monitoring | Mya Jaye"><meta property="twitter:description" content=""><meta property="twitter:image" content="https://mya.sh/img/blog-placeholder-5.jpg"><link rel="stylesheet" href="/_astro/_slug_.g_98uJJA.css">
<style>main[data-astro-cid-bvzihdzo]{width:960px;max-width:calc(100% - 2em);margin:0 auto}div[data-astro-cid-bvzihdzo].prose{width:800px;max-width:calc(100% - 2em);margin:2em auto 0;color:var(--color-text)}.hero-image[data-astro-cid-bvzihdzo]{margin-top:30px;width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.title[data-astro-cid-bvzihdzo]{margin:2em 0 1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:var(--color-text)}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}footer[data-astro-cid-bvzihdzo]{padding:2em 1em 6em;color:var(--color-text);text-align:center}.light-dark[data-astro-cid-bvzihdzo]{position:fixed;top:0;left:0;padding:10px}
</style><script type="module">const t=document.querySelector('.theme-switch input[type="checkbox"]'),e=localStorage.getItem("theme");e&&(document.documentElement.setAttribute("data-theme",e),e==="dark"&&(t.checked=!0));function m(c){c.target.checked?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"))}t.addEventListener("change",m,!1);
</script></head> <body data-astro-cid-bvzihdzo> <div class="light-dark" data-astro-cid-bvzihdzo> <div class="theme-switch-wrapper"> <label class="theme-switch" for="checkbox"> <input type="checkbox" id="checkbox"> <div class="slider"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FCD53F" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </div> </label>  </div> </div> <main data-astro-cid-bvzihdzo> <div class="social-links" data-astro-cid-yxtifmrq> <a href="https://linktr.ee/MsMyaJaye" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>Linktree</span> <svg viewBox="0 0 24 24" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M7.953 15.066c-.08.163-.08.324-.08.486.08.517.528.897 1.052.89h1.294v4.776c0 .486-.404.89-.89.89H6.577a.898.898 0 0 1-.889-.891v-4.774H.992c-.728 0-1.214-.729-.89-1.377l6.96-12.627a1.065 1.065 0 0 1 1.863 0l2.913 5.585-3.885 7.042zm15.945 0-6.96-12.627a1.065 1.065 0 0 0-1.862 0l-2.995 5.586 3.885 7.04c.081.164.081.326.081.487-.08.517-.529.897-1.052.89h-1.296v4.776c.005.49.4.887.89.89h2.914a.9.9 0 0 0 .892-.89v-4.775h4.612c.73 0 1.214-.729.89-1.377z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://twitter.com/MsMyaJaye/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>Twitter</span> <svg viewBox="0 0 310 310" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M302.973,57.388c-4.87,2.16-9.877,3.983-14.993,5.463c6.057-6.85,10.675-14.91,13.494-23.73 c0.632-1.977-0.023-4.141-1.648-5.434c-1.623-1.294-3.878-1.449-5.665-0.39c-10.865,6.444-22.587,11.075-34.878,13.783 c-12.381-12.098-29.197-18.983-46.581-18.983c-36.695,0-66.549,29.853-66.549,66.547c0,2.89,0.183,5.764,0.545,8.598 C101.163,99.244,58.83,76.863,29.76,41.204c-1.036-1.271-2.632-1.956-4.266-1.825c-1.635,0.128-3.104,1.05-3.93,2.467 c-5.896,10.117-9.013,21.688-9.013,33.461c0,16.035,5.725,31.249,15.838,43.137c-3.075-1.065-6.059-2.396-8.907-3.977 c-1.529-0.851-3.395-0.838-4.914,0.033c-1.52,0.871-2.473,2.473-2.513,4.224c-0.007,0.295-0.007,0.59-0.007,0.889 c0,23.935,12.882,45.484,32.577,57.229c-1.692-0.169-3.383-0.414-5.063-0.735c-1.732-0.331-3.513,0.276-4.681,1.597 c-1.17,1.32-1.557,3.16-1.018,4.84c7.29,22.76,26.059,39.501,48.749,44.605c-18.819,11.787-40.34,17.961-62.932,17.961 c-4.714,0-9.455-0.277-14.095-0.826c-2.305-0.274-4.509,1.087-5.294,3.279c-0.785,2.193,0.047,4.638,2.008,5.895 c29.023,18.609,62.582,28.445,97.047,28.445c67.754,0,110.139-31.95,133.764-58.753c29.46-33.421,46.356-77.658,46.356-121.367 c0-1.826-0.028-3.67-0.084-5.508c11.623-8.757,21.63-19.355,29.773-31.536c1.237-1.85,1.103-4.295-0.33-5.998 C307.394,57.037,305.009,56.486,302.973,57.388z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://youtube.com/@Ms-Mya-Dev/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>YouTube</span> <svg viewBox="0 0 310 310" width="32" height="32" data-astro-cid-yxtifmrq> <g data-astro-cid-yxtifmrq> <path fill="currentColor" d="M297.917,64.645c-11.19-13.302-31.85-18.728-71.306-18.728H83.386c-40.359,0-61.369,5.776-72.517,19.938   C0,79.663,0,100.008,0,128.166v53.669c0,54.551,12.896,82.248,83.386,82.248h143.226c34.216,0,53.176-4.788,65.442-16.527   C304.633,235.518,310,215.863,310,181.835v-53.669C310,98.471,309.159,78.006,297.917,64.645z M199.021,162.41l-65.038,33.991   c-1.454,0.76-3.044,1.137-4.632,1.137c-1.798,0-3.592-0.484-5.181-1.446c-2.992-1.813-4.819-5.056-4.819-8.554v-67.764   c0-3.492,1.822-6.732,4.808-8.546c2.987-1.814,6.702-1.938,9.801-0.328l65.038,33.772c3.309,1.718,5.387,5.134,5.392,8.861   C204.394,157.263,202.325,160.684,199.021,162.41z" data-astro-cid-yxtifmrq></path> </g> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-yxtifmrq></path> </svg> </a> </div>  <nav data-astro-cid-pux6a34n> <div class="internal-links" data-astro-cid-pux6a34n> <a href="/" data-astro-cid-pux6a34n data-astro-cid-eimmu3lg> About </a>  <a href="/blog" class="active" data-astro-cid-pux6a34n data-astro-cid-eimmu3lg> Blog </a>  <a href="/charts" data-astro-cid-pux6a34n data-astro-cid-eimmu3lg> Charts </a>  <a href="/media" data-astro-cid-pux6a34n data-astro-cid-eimmu3lg> Media </a>  <a href="/collab" data-astro-cid-pux6a34n data-astro-cid-eimmu3lg> Collaborate </a>  </div> </nav>  <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/img/blog-placeholder-5.jpg" alt="" data-astro-cid-bvzihdzo> </div> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2019-04-21T00:00:00.000Z"> Apr 21, 2019 </time>  </div>  <h1 data-astro-cid-bvzihdzo>Raspberry Pi Cluster Monitoring</h1> <hr data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo>  <p>In my last few posts, I talked a bit about my at home development cluster.
Due to the flexibility of my cluster, I wanted to provide a monitoring solution that was valuable across each technology I use.
In this post, I discuss how monitoring is setup on my cluster.
I’ll walk through setting up each node, the Prometheus server, and the Graphana UI.</p>
<!--more-->
<p>First, if you haven’t read my previous posts, I suggest going back and giving them a quick read.</p>
<ul>
<li><a href="/blog/2019/03/17/64bit-raspberry-pi">Easy Steps to a 64bit Raspberry Pi 3 B/B+</a></li>
<li><a href="/blog/2019/04/10/k8s-k3s-rpi-oh-my">k3s on Raspberry Pi</a></li>
<li><a href="/blog/2019/04/12/rpi-cluster-setup">Raspberry Pi Cluster Setup</a></li>
</ul>
<p>Historically, I haven’t put much monitoring in beyond the basic orchestrator level tooling.
This was due to the lack of native ARM support on the Prometheus project.
Sure there were a couple personal forks running out on the web.
Some of them were well documented, but I tended to resort to compiling it myself.
Many people in the ARM community have been waiting for support upstream.</p>
<center>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">This should be available soon hopefully<a href="https://t.co/3TXc4SjIug">https://t.co/3TXc4SjIug</a></p>— Simon P (@SimonHiker) <a href="https://twitter.com/SimonHiker/status/1104430227785244672?ref_src=twsrc%5Etfw">March 9, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</center>
<p>6 days ago, <a href="https://prometheus.io">Prometheus</a> merged in support for <a href="https://github.com/prometheus/prometheus/pull/5031">ARM based architectures</a>.
I briefly stumbled across a tweet this week where someone mentioned that native support was now offered upstream.
Unfortunately, I managed to misplace that tweet.
With some free time on my hands, I decided to go looking for the images and get a solution running on my cluster at home.</p>
<h2 id="running-node_exporter-on-each-node">Running node_exporter on each node</h2>
<p>node_exporter is a project from the Prometheus team.
It provides host level information such as cpu, memory, and disk usage.
It also provides more detailed information such as open and max file descriptor counts, memory swap, cpu steal, etc.
In order to get started with the project, you either had to use the container image or go out and compile your own binary.
With the recent introduction of the ARM image, running this has become a bit easier.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> docker</span><span style="color:#9ECBFF"> run</span><span style="color:#79B8FF"> -d</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --name</span><span style="color:#9ECBFF"> "node-exporter"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --network</span><span style="color:#9ECBFF"> "host"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --pid</span><span style="color:#9ECBFF"> "host"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --restart</span><span style="color:#9ECBFF"> "always"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    -v</span><span style="color:#9ECBFF"> "/:/host:ro,rslave"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">    prom/node-exporter-linux-arm64:master</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --path.rootfs</span><span style="color:#9ECBFF"> /host</span></span>
<span class="line"></span></code></pre>
<p>You can verify that this process started up successfully by curling the metrics endpoint of the process.
Over time, this page will be updated based on the current usage of the system.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> curl</span><span style="color:#9ECBFF"> http://</span><span style="color:#E1E4E8">${ip_address}</span><span style="color:#9ECBFF">:9100/metrics</span></span>
<span class="line"></span></code></pre>
<p>Repeat this process for each node within your cluster.</p>
<h2 id="picking-a-monitoring-node">Picking a monitoring node</h2>
<p>I want to explicitly call out to the “monitoring” node aspect of this section.
A monitoring node in this case is simply a node who has a large amount of disk space.
Prometheus works by aggregating data from different exporters.
Since it collects all this information in one place, you will need to ensure you have enough storage.
Alternatively, you can leverage an attachable storage solution, like <a href="https://ceph.com/">Ceph</a>.
Since my setup is rather minimum, I run this on my laptop during times of experimentation.</p>
<h2 id="running-prometheus-and-graphana">Running Prometheus and Graphana</h2>
<p>Before starting the Prometheus server, you need a configuration file.
This file tells Prometheus where it can gather metrics from.
In this case, we use a static_config that points at every node in the cluster.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#85E89D">global</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  scrape_interval</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">1m</span></span>
<span class="line"><span style="color:#85E89D">  scrape_timeout</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">10s</span></span>
<span class="line"><span style="color:#85E89D">  evaluation_interval</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">1m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">scrape_configs</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">job_name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">node-exporter</span></span>
<span class="line"><span style="color:#85E89D">    static_configs</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#85E89D">targets</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.100:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.101:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.102:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.103:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.104:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.105:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.106:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.107:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.108:9100</span></span>
<span class="line"><span style="color:#E1E4E8">        - </span><span style="color:#9ECBFF">192.168.1.109:9100</span></span>
<span class="line"></span></code></pre>
<p>Once the configuration file is defined, I started to look into how to deploy this setup.
I wound up finding docker-compose files to be the best way to managed this.
By using something like <code>docker stack deploy</code>, we’re able to leverage the <code>configs</code> semantic.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#85E89D">version</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"3.7"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">volumes</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  prometheus-data</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  graphana-data</span><span style="color:#E1E4E8">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">configs</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  prometheus-config</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    file</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">./prometheus.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">services</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  prometheus</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    hostname</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">prometheus</span></span>
<span class="line"><span style="color:#85E89D">    configs</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#85E89D">source</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">prometheus-config</span></span>
<span class="line"><span style="color:#85E89D">        target</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">/prometheus.yaml</span></span>
<span class="line"><span style="color:#85E89D">    volumes</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#9ECBFF">prometheus-data:/prometheus</span></span>
<span class="line"><span style="color:#85E89D">    ports</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#9ECBFF">9090:9090</span></span>
<span class="line"><span style="color:#85E89D">    image</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">prom/prometheus</span></span>
<span class="line"><span style="color:#85E89D">    command</span><span style="color:#E1E4E8">: [</span></span>
<span class="line"><span style="color:#9ECBFF">      --config.file</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">/prometheus.yaml</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      --storage.tsdb.path</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">/prometheus</span></span>
<span class="line"><span style="color:#E1E4E8">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">  graphana</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    hostname</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">graphana</span></span>
<span class="line"><span style="color:#85E89D">    volumes</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#9ECBFF">graphana-data:/var/lib/grafana</span></span>
<span class="line"><span style="color:#85E89D">    ports</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#9ECBFF">3000:3000</span></span>
<span class="line"><span style="color:#85E89D">    image</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">grafana/grafana</span></span>
<span class="line"></span></code></pre>
<p>Alternatively leverage the <code>docker run</code> command similar to node_exporter, but using a local volume mount instead of a config.
Once these two processes are up and running you should be able to navigate to the UI in the browser.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> open</span><span style="color:#9ECBFF"> http://</span><span style="color:#E1E4E8">${ip_address}</span><span style="color:#9ECBFF">:9090</span><span style="color:#6A737D">   # prometheus</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> open</span><span style="color:#9ECBFF"> http://</span><span style="color:#E1E4E8">${ip_address}</span><span style="color:#9ECBFF">:3000</span><span style="color:#6A737D">   # graphana</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">## on linux, this will be "xdg-open" instead of "open"</span></span>
<span class="line"></span></code></pre>
<h3 id="adding-prometheus-as-a-data-source-to-graphana">Adding Prometheus as a data source to Graphana</h3>
<p>Once you have the Graphana interface open, you’ll need to configure a data source.
Graphana supports Prometheus as a data source out of box, so connecting them is easy.
In the address line, you’ll want to point it at your Prometheus server.
For me, this was <code>http://prometheus:9090</code>.
By default, docker sets up an overlay network across containers in a compose file.
This means that we’re able to connect services on the same network using their <code>hostname</code>.</p>
<h3 id="adding-dashboards">Adding dashboards</h3>
<p>Once the data source has been configured, you can start adding dashboards to Graphana.
Graphana offers tons of <a href="https://grafana.com/dashboards">pre-built dashboards</a>.
They’re mostly community driven, so finding a well maintained dashboard can be difficult.
The first dashboard I found extremely useful is the <a href="https://grafana.com/dashboards/1860">full export of all node_exporter</a> metrics.</p>
<p><img src="/img/rpi-mon-node-exporter-full.png" alt="Node Exporter Full"></p>
<p>Using this dashboard, I’m able to get a detailed view of each node.
It encapsulates all metrics emitted by node_exporter into a single dashboard.
While this might seem overwhelming, the dashboard collapses the more detailed panels.
This makes it easy to get a high level view of a node, and then dive in.</p>
<p>One thing that this dashboard did not enable was a complete overview of all nodes in the cluster.
In the past, this kind of dashboard has been extremely useful when investigating capacity constraints.
In Datadog, this was a rather easy thing to setup:</p>
<p><img src="/img/rpi-mon-dd.jpg" alt="Datadog Host Map"></p>
<p>After looking around for a bit, I wasn’t able to find a rough equivalent.
So I started to build and prototype my own.
First, I started with a few of the queries from the Node Exporter Full dashboard.
With a few modifications, I was able to get something started.</p>
<p><img src="/img/rpi-mon-cluster-overview.png" alt="Cluster Overview"></p>
<p>While it may not look as nice as the host map in Datadog, I was able to get the same view of information.
First, I look for the capacity of the cluster as a whole.
The three gauges along the top monitor the current clusters usage across all nodes.
The 3 heat maps along the bottom show the same usage broken down by each instance in the cluster, over time.
This allows me to be able to track drastic changes in compute, memory, or disk back to an originating point.</p>
<p>Using the combination of these dashboard, I can quickly get an idea of what my cluster is doing at any given time.
Should I require more orchestrator related information, then I can follow up with their supplied monitoring.
For Docker, I use <a href="https://portainer.io">portainer</a>.
For Kubernetes and K3s, I use the <a href="https://github.com/kubernetes/dashboard">kubernetes-dashboard</a>.
In Nomad, I’ll use the <a href="https://www.nomadproject.io/">Nomad</a> and <a href="https://www.consul.io/">Consul</a> views.</p>  </div> </main> <footer data-astro-cid-bvzihdzo> <p data-astro-cid-bvzihdzo>&copy; 2024&nbsp;Mya Jaye. All rights reserved.</p> <div class="social-links" data-astro-cid-yxtifmrq> <a href="https://linktr.ee/MsMyaJaye" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>Linktree</span> <svg viewBox="0 0 24 24" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M7.953 15.066c-.08.163-.08.324-.08.486.08.517.528.897 1.052.89h1.294v4.776c0 .486-.404.89-.89.89H6.577a.898.898 0 0 1-.889-.891v-4.774H.992c-.728 0-1.214-.729-.89-1.377l6.96-12.627a1.065 1.065 0 0 1 1.863 0l2.913 5.585-3.885 7.042zm15.945 0-6.96-12.627a1.065 1.065 0 0 0-1.862 0l-2.995 5.586 3.885 7.04c.081.164.081.326.081.487-.08.517-.529.897-1.052.89h-1.296v4.776c.005.49.4.887.89.89h2.914a.9.9 0 0 0 .892-.89v-4.775h4.612c.73 0 1.214-.729.89-1.377z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://github.com/mjpitz" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://www.linkedin.com/in/mjpitz/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>LinkedIn</span> <svg viewBox="0 0 50 50" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M41,4H9C6.24,4,4,6.24,4,9v32c0,2.76,2.24,5,5,5h32c2.76,0,5-2.24,5-5V9C46,6.24,43.76,4,41,4z M17,20v19h-6V20H17z M11,14.47c0-1.4,1.2-2.47,3-2.47s2.93,1.07,3,2.47c0,1.4-1.12,2.53-3,2.53C12.2,17,11,15.87,11,14.47z M39,39h-6c0,0,0-9.26,0-10 c0-2-1-4-3.5-4.04h-0.08C27,24.96,26,27.02,26,29c0,0.91,0,10,0,10h-6V20h6v2.56c0,0,1.93-2.56,5.81-2.56 c3.97,0,7.19,2.73,7.19,8.26V39z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://twitter.com/MsMyaJaye/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>Twitter</span> <svg viewBox="0 0 310 310" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M302.973,57.388c-4.87,2.16-9.877,3.983-14.993,5.463c6.057-6.85,10.675-14.91,13.494-23.73 c0.632-1.977-0.023-4.141-1.648-5.434c-1.623-1.294-3.878-1.449-5.665-0.39c-10.865,6.444-22.587,11.075-34.878,13.783 c-12.381-12.098-29.197-18.983-46.581-18.983c-36.695,0-66.549,29.853-66.549,66.547c0,2.89,0.183,5.764,0.545,8.598 C101.163,99.244,58.83,76.863,29.76,41.204c-1.036-1.271-2.632-1.956-4.266-1.825c-1.635,0.128-3.104,1.05-3.93,2.467 c-5.896,10.117-9.013,21.688-9.013,33.461c0,16.035,5.725,31.249,15.838,43.137c-3.075-1.065-6.059-2.396-8.907-3.977 c-1.529-0.851-3.395-0.838-4.914,0.033c-1.52,0.871-2.473,2.473-2.513,4.224c-0.007,0.295-0.007,0.59-0.007,0.889 c0,23.935,12.882,45.484,32.577,57.229c-1.692-0.169-3.383-0.414-5.063-0.735c-1.732-0.331-3.513,0.276-4.681,1.597 c-1.17,1.32-1.557,3.16-1.018,4.84c7.29,22.76,26.059,39.501,48.749,44.605c-18.819,11.787-40.34,17.961-62.932,17.961 c-4.714,0-9.455-0.277-14.095-0.826c-2.305-0.274-4.509,1.087-5.294,3.279c-0.785,2.193,0.047,4.638,2.008,5.895 c29.023,18.609,62.582,28.445,97.047,28.445c67.754,0,110.139-31.95,133.764-58.753c29.46-33.421,46.356-77.658,46.356-121.367 c0-1.826-0.028-3.67-0.084-5.508c11.623-8.757,21.63-19.355,29.773-31.536c1.237-1.85,1.103-4.295-0.33-5.998 C307.394,57.037,305.009,56.486,302.973,57.388z" data-astro-cid-yxtifmrq></path> </svg> </a> <a href="https://youtube.com/@Ms-Mya-Dev/" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>YouTube</span> <svg viewBox="0 0 310 310" width="32" height="32" data-astro-cid-yxtifmrq> <g data-astro-cid-yxtifmrq> <path fill="currentColor" d="M297.917,64.645c-11.19-13.302-31.85-18.728-71.306-18.728H83.386c-40.359,0-61.369,5.776-72.517,19.938   C0,79.663,0,100.008,0,128.166v53.669c0,54.551,12.896,82.248,83.386,82.248h143.226c34.216,0,53.176-4.788,65.442-16.527   C304.633,235.518,310,215.863,310,181.835v-53.669C310,98.471,309.159,78.006,297.917,64.645z M199.021,162.41l-65.038,33.991   c-1.454,0.76-3.044,1.137-4.632,1.137c-1.798,0-3.592-0.484-5.181-1.446c-2.992-1.813-4.819-5.056-4.819-8.554v-67.764   c0-3.492,1.822-6.732,4.808-8.546c2.987-1.814,6.702-1.938,9.801-0.328l65.038,33.772c3.309,1.718,5.387,5.134,5.392,8.861   C204.394,157.263,202.325,160.684,199.021,162.41z" data-astro-cid-yxtifmrq></path> </g> </svg> </a> <a href="/rss.xml" target="_blank" data-astro-cid-yxtifmrq> <span class="sr-only" data-astro-cid-yxtifmrq>RSS</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-yxtifmrq> <path fill="currentColor" d="M1,5v2c1.081,0,2.128,0.211,3.113,0.628c0.952,0.403,1.808,0.98,2.543,1.715s1.312,1.591,1.715,2.543 C8.789,12.872,9,13.919,9,15h2C11,9.477,6.523,5,1,5z M4,10c-1.105,0-2,0.895-2,2s0.895,2,2,2s2-0.895,2-2S5.105,10,4,10z M1,1v2 c1.621,0,3.192,0.317,4.67,0.942c1.429,0.604,2.712,1.47,3.815,2.573c1.103,1.103,1.968,2.386,2.573,3.815 C12.683,11.808,13,13.379,13,15h2C15,7.268,8.732,1,1,1z" data-astro-cid-yxtifmrq></path> </svg> </a> </div>  </footer> </body></html>