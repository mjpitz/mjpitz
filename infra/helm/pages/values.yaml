12factor:
  nameOverride: pages

  image:
    repository: img.pitz.tech/mya/pages
    tag: latest@sha256:9557cccb0aafd0b3dc896fbca0aab8039270dc2d7e577c67f9f9f0f7e0cc53c3

  deployment:
    replicaCount: 2

    application:
      envFrom:
        - secretRef:
            name: pages-secret
      ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: debug
          containerPort: 8081
          protocol: TCP

  networking:
    service:
      ports:
        - name: http
          targetPort: http
          protocol: TCP
          port: 8080
        - name: debug
          targetPort: debug
          protocol: TCP
          port: 8081

    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: nginx
        kubernetes.io/tls-acme: "true"
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/server-snippet: |
          location = /_session/pages.js {}
          
          location /_session/ {
            proxy_set_header Upgrade $http_upgrade;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;
          }
      hosts:
        - host: mjpitz.com
          paths:
            - path: /
              pathType: ImplementationSpecific
      tls:
        - secretName: pages-tls
          hosts:
            - mjpitz.com

metrics:
  serviceMonitor:
    interval: 10s
